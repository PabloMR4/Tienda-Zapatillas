<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin - Moda Store</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
        }

        .sidebar {
            width: 260px;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .sidebar-header {
            padding: 25px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
        }

        .sidebar-header h2 {
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            font-size: 0.85em;
            opacity: 0.9;
        }

        .sidebar-menu {
            flex: 1;
            padding: 20px 0;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 15px 25px;
            color: #333;
            text-decoration: none;
            transition: all 0.3s;
            cursor: pointer;
            border-left: 4px solid transparent;
        }

        .menu-item:hover {
            background: #f5f5f5;
            border-left-color: #667eea;
        }

        .menu-item.active {
            background: #e8eaf6;
            border-left-color: #667eea;
            color: #667eea;
            font-weight: 600;
        }

        .menu-item-icon {
            font-size: 1.3em;
            margin-right: 12px;
            width: 25px;
            text-align: center;
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        h1 {
            color: white;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .pedidos-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .pedido-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .pedido-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .pedido-card-resumido {
            cursor: pointer;
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .pedido-card-resumido:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            background: #fafbfc;
        }

        .pedido-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .pedido-id {
            font-weight: bold;
            color: #667eea;
            font-size: 1.1em;
        }

        .pedido-fecha {
            color: #666;
            font-size: 0.9em;
        }

        .estado {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .estado.pendiente {
            background: #ffeaa7;
            color: #d63031;
        }

        .estado.completado {
            background: #55efc4;
            color: #00b894;
        }

        .estado.enviado {
            background: #74b9ff;
            color: #0984e3;
        }

        .pedido-cliente {
            margin-bottom: 10px;
            color: #333;
        }

        .pedido-items {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .item:last-child {
            border-bottom: none;
        }

        .pedido-total {
            font-size: 1.2em;
            font-weight: bold;
            color: #667eea;
            text-align: right;
            margin-top: 10px;
        }

        .no-pedidos {
            text-align: center;
            color: #999;
            padding: 40px;
            font-size: 1.1em;
        }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            display: block;
            margin: 20px auto;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .refresh-btn:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(118, 75, 162, 0.4);
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 1.2em;
            padding: 20px;
        }

        .navbar {
            background: white;
            padding: 15px 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .logout-btn {
            background: #f44336;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: #d32f2f;
            transform: translateY(-2px);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .empty-section {
            background: white;
            border-radius: 15px;
            padding: 60px 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .empty-section-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-section h3 {
            color: #666;
            margin-bottom: 10px;
            font-size: 1.5em;
        }

        .empty-section p {
            color: #999;
            font-size: 1em;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95em;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 10px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95em;
            transition: all 0.3s;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }

        .productos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .producto-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .producto-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .producto-imagen {
            width: 100%;
            height: 250px;
            object-fit: contain;
            background: #f8f8f8;
        }

        .producto-info {
            padding: 15px;
        }

        .producto-nombre {
            font-weight: 600;
            font-size: 1.1em;
            color: #333;
            margin-bottom: 8px;
        }

        .producto-precio {
            color: #667eea;
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .producto-categoria {
            display: inline-block;
            background: #e8eaf6;
            color: #667eea;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            margin-bottom: 10px;
        }

        .producto-actions {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
        }

        .btn-small {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-edit {
            background: #4caf50;
            color: white;
        }

        .btn-edit:hover {
            background: #45a049;
        }

        .btn-delete {
            background: #f44336;
            color: white;
        }

        .btn-delete:hover {
            background: #d32f2f;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-header h2 {
            margin: 0;
            color: #333;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        .file-upload-area {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload-area:hover {
            background: #e8eaf6;
        }

        .file-upload-area input[type="file"] {
            display: none;
        }

        #ultimos-productos-dashboard {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        @media (max-width: 1024px) {
            #inicio .container > div[style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }

            #ultimos-productos-dashboard {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                min-height: auto;
            }

            .main-content {
                padding: 10px;
            }

            #ultimos-productos-dashboard {
                grid-template-columns: 1fr;
            }
        }

        /* Estilos para Marketing */
        .tab-btn {
            padding: 15px 30px;
            background: white;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            color: #667eea;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .marketing-tab {
            display: none;
        }

        .marketing-tab.active {
            display: block;
        }

        .producto-rrss-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .producto-rrss-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .producto-rrss-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .producto-rrss-card h3 {
            font-size: 1em;
            margin: 10px 0;
            color: #333;
        }

        .producto-rrss-card .precio {
            font-size: 1.2em;
            color: #667eea;
            font-weight: bold;
            margin: 10px 0;
        }

        .rrss-buttons {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .rrss-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            color: white;
            transition: all 0.3s;
        }

        .rrss-btn.instagram {
            background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
        }

        .rrss-btn.facebook {
            background: #1877f2;
        }

        .rrss-btn.twitter {
            background: #1da1f2;
        }

        .rrss-btn:hover {
            transform: scale(1.05);
        }

        /* Estilos para tarjetas (cards) */
        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .card-header h2 {
            margin: 0;
            color: #333;
            font-size: 1.5em;
        }

        .search-box {
            flex-shrink: 0;
        }

        /* Estilos para las tablas de datos */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 0.95em;
        }

        .data-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .data-table thead th {
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table tbody tr {
            border-bottom: 1px solid #e0e0e0;
            transition: background-color 0.2s;
        }

        .data-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .data-table tbody td {
            padding: 16px 12px;
            vertical-align: middle;
        }

        .data-table tbody tr:last-child {
            border-bottom: none;
        }

        .data-table .loading,
        .data-table .error {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 1em;
        }

        .data-table .error {
            color: #f44336;
        }

        /* Estilos de paginación */
        .btn-paginacion {
            background: white;
            border: 2px solid #e0e0e0;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            transition: all 0.2s;
        }

        .btn-paginacion:hover:not(:disabled) {
            border-color: #000;
            background: #f8f8f8;
        }

        .btn-paginacion.active {
            background: #000;
            color: white;
            border-color: #000;
        }

        .btn-paginacion:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>ShoeLandia</h2>
            <p>Panel Administrativo</p>
        </div>

        <div class="sidebar-menu">
            <div class="menu-item active" onclick="showSection('inicio')">
                <span class="menu-item-icon">🏠</span>
                <span>Inicio</span>
            </div>
            <div class="menu-item" onclick="showSection('pedidos')">
                <span class="menu-item-icon">📋</span>
                <span>Pedidos</span>
            </div>
            <div class="menu-item" onclick="showSection('productos')">
                <span class="menu-item-icon">📦</span>
                <span>Productos</span>
            </div>
            <div class="menu-item" onclick="showSection('descuentos')">
                <span class="menu-item-icon">🎟️</span>
                <span>Descuentos</span>
            </div>
            <div class="menu-item" onclick="showSection('clientes')">
                <span class="menu-item-icon">👥</span>
                <span>Clientes</span>
            </div>
            <div class="menu-item" onclick="showSection('tickets')">
                <span class="menu-item-icon">🎫</span>
                <span>Tickets de Soporte</span>
            </div>
            <div class="menu-item" onclick="showSection('marketing')">
                <span class="menu-item-icon">📧</span>
                <span>Marketing</span>
            </div>
            <div class="menu-item" onclick="showSection('analiticas')">
                <span class="menu-item-icon">📊</span>
                <span>Analíticas</span>
            </div>
        </div>

        <div class="sidebar-footer">
            <div class="user-info" style="margin-bottom: 15px;">
                <div class="user-avatar" id="user-avatar">A</div>
                <div style="margin-left: 10px;">
                    <div style="font-weight: 600; color: #333; font-size: 0.9em;" id="username-display">Administrador</div>
                    <div style="font-size: 0.75em; color: #666;">Administrador</div>
                </div>
            </div>
            <button class="logout-btn" onclick="logout()" style="width: 100%; padding: 10px;">🚪 Cerrar Sesión</button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Sección Inicio -->
        <div id="inicio" class="section active">
            <div class="container">
                <h1>📊 Dashboard</h1>

                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="total-pedidos">0</div>
                        <div class="stat-label">Total Pedidos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="pedidos-pendientes">0</div>
                        <div class="stat-label">Pendientes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ingresos-totales">€0</div>
                        <div class="stat-label">Ingresos Totales</div>
                    </div>
                </div>

                <!-- Grid para Últimos Pedidos y Productos en formato 1x2 -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                    <!-- Últimos Pedidos -->
                    <div style="background: white; border-radius: 15px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="margin: 0;">📋 Últimos Pedidos</h2>
                            <button class="btn-secondary" onclick="showSection('pedidos')" style="padding: 8px 20px; font-size: 0.85em;">Ver Todos</button>
                        </div>
                        <div id="ultimos-pedidos-dashboard">
                            <div class="loading" style="color: #667eea;">Cargando pedidos...</div>
                        </div>
                    </div>

                    <!-- Últimos Productos Añadidos -->
                    <div style="background: white; border-radius: 15px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="margin: 0;">📦 Últimos Productos Añadidos</h2>
                            <button class="btn-secondary" onclick="showSection('productos')" style="padding: 8px 20px; font-size: 0.85em;">Ver Todos</button>
                        </div>
                        <div id="ultimos-productos-dashboard">
                            <div class="loading" style="color: #667eea;">Cargando productos...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sección Pedidos -->
        <div id="pedidos" class="section">
            <div class="container">
                <h1>📋 Pedidos</h1>

                <div class="pedidos-container">
                    <h2>Todos los Pedidos</h2>
                    <button class="refresh-btn" onclick="cargarPedidos()">🔄 Actualizar</button>
                    <div id="pedidos-lista">
                        <div class="loading">Cargando pedidos...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sección Productos -->
        <div id="productos" class="section">
            <div class="container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h1 style="margin: 0;">📦 Productos</h1>
                    <div id="ultima-actualizacion-display" style="background: #e3f2fd; padding: 12px 20px; border-radius: 10px; border-left: 4px solid #2196f3;">
                        <div style="font-size: 0.75em; color: #666; margin-bottom: 3px;">Última actualización automática</div>
                        <div id="ultima-actualizacion-texto" style="font-weight: 600; color: #1976d2; font-size: 0.9em;">
                            Cargando...
                        </div>
                        <button onclick="forzarActualizacion()" style="margin-top: 8px; padding: 5px 12px; font-size: 0.8em; background: #2196f3; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            🔄 Actualizar ahora
                        </button>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn-primary" onclick="abrirModalProducto()">➕ Nuevo Producto</button>
                    <button class="btn-secondary" onclick="abrirModalCategorias()">🏷️ Añadir/Editar Categorías</button>
                    <button class="btn-secondary" onclick="abrirModalActualizarProductos()" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);">🔄 Actualizar Productos</button>
                    <button class="btn-secondary" onclick="abrirModalProductosNuevos()" style="background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);">✨ Añadir Productos Nuevos</button>
                    <button id="btnEliminarSeleccionados" class="btn-secondary" onclick="eliminarProductosSeleccionados()" style="background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); display: none;">🗑️ Eliminar Seleccionados (<span id="contadorSeleccionados">0</span>)</button>
                </div>

                <div style="background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: 600; color: #333;">
                                <input type="checkbox" id="selectAllProductos" onchange="seleccionarTodos(this.checked)" style="width: 18px; height: 18px; cursor: pointer;">
                                <span>Seleccionar todos</span>
                            </label>
                        </div>
                        <div style="flex: 1; min-width: 250px;">
                            <input type="text" id="searchProducto" placeholder="🔍 Buscar producto..." class="form-control" onkeyup="filtrarProductos()">
                        </div>
                        <div style="min-width: 200px;">
                            <select id="filterCategoria" class="form-control" onchange="filtrarProductos()">
                                <option value="">Todas las categorías</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="productos-grid" class="productos-grid">
                    <div class="loading">Cargando productos...</div>
                </div>

                <!-- Paginación -->
                <div id="paginacion-productos"></div>
            </div>
        </div>

        <!-- Sección Descuentos -->
        <div id="descuentos" class="section">
            <div class="container">
                <h1>🎟️ Descuentos</h1>

                <div class="action-buttons">
                    <button class="btn-primary" onclick="abrirModalDescuento()">➕ Nuevo Descuento</button>
                </div>

                <div style="background: white; border-radius: 15px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                    <h2>Descuentos Activos</h2>
                    <div id="descuentos-lista">
                        <div class="loading">Cargando descuentos...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sección Clientes -->
        <div id="clientes" class="section">
        <div class="container">
            <h1>👥 Clientes</h1>

            <div class="card">
                <div class="card-header">
                    <h2>📊 Estadísticas Generales</h2>
                </div>
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="total-clientes">0</div>
                        <div class="stat-label">Total Clientes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="clientes-con-pedidos">0</div>
                        <div class="stat-label">Con Pedidos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ingresos-clientes">€0</div>
                        <div class="stat-label">Ingresos Totales</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>Lista de Clientes</h2>
                    <div class="search-box">
                        <input type="text" id="buscar-cliente" placeholder="Buscar cliente..."
                               onkeyup="filtrarClientes()" style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; width: 300px;">
                    </div>
                </div>

                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Email</th>
                                <th>Teléfono</th>
                                <th>Fecha Registro</th>
                                <th>N° Pedidos</th>
                                <th>Total Gastado</th>
                                <th>Último Pedido</th>
                            </tr>
                        </thead>
                        <tbody id="clientes-tabla">
                            <tr>
                                <td colspan="7" class="loading">Cargando clientes...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        </div>

        <!-- Sección Marketing -->
        <div id="marketing" class="section">
            <div class="container">
                <h1>📧 Marketing</h1>

                <!-- Pestañas de Marketing -->
                <div style="display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #e0e0e0;">
                    <button class="tab-btn active" onclick="showMarketingTab('correo')" id="tab-correo">
                        📧 Marketing Correo
                    </button>
                    <button class="tab-btn" onclick="showMarketingTab('rrss')" id="tab-rrss">
                        📱 Marketing RRSS
                    </button>
                </div>

                <!-- Marketing Correo -->
                <div id="marketing-correo" class="marketing-tab active">
                    <div class="card">
                        <div class="card-header">
                            <h2>📊 Clientes y Gastos</h2>
                            <button class="refresh-btn" onclick="cargarClientesMarketing()">🔄 Actualizar</button>
                        </div>

                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="select-all-clientes" onchange="toggleSelectAllClientes()"></th>
                                        <th>Cliente</th>
                                        <th>Email</th>
                                        <th>Pedidos</th>
                                        <th>Total Gastado</th>
                                        <th>Último Pedido</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tabla-clientes-marketing">
                                    <tr>
                                        <td colspan="7" style="text-align: center; padding: 40px;">
                                            <p style="color: #999;">Cargando clientes...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div style="margin-top: 20px; display: flex; gap: 10px;">
                            <button class="btn-primary" onclick="abrirModalEmailMasivo()">
                                ✉️ Enviar Email a Seleccionados
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Marketing RRSS -->
                <div id="marketing-rrss" class="marketing-tab" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h2>📱 Compartir Productos en Redes Sociales</h2>
                            <button class="refresh-btn" onclick="cargarProductosRRSS()">🔄 Actualizar</button>
                        </div>

                        <div id="productos-rrss-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; padding: 20px;">
                            <!-- Productos se cargarán aquí -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sección Tickets de Soporte -->
        <div id="tickets" class="section">
            <div class="container">
                <h1>🎫 Tickets de Soporte</h1>

                <div class="card">
                    <div class="card-header">
                        <h2>📊 Estadísticas de Tickets</h2>
                    </div>
                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-number" id="total-tickets">0</div>
                            <div class="stat-label">Total Tickets</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="tickets-nuevos">0</div>
                            <div class="stat-label">Nuevos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="tickets-en-proceso">0</div>
                            <div class="stat-label">En Proceso</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="tickets-resueltos">0</div>
                            <div class="stat-label">Resueltos</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2>📋 Lista de Tickets</h2>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <select id="filtro-estado-ticket" onchange="filtrarTickets()" class="form-control" style="width: auto;">
                                <option value="">Todos los estados</option>
                                <option value="Nuevo">Nuevo</option>
                                <option value="En Proceso">En Proceso</option>
                                <option value="Resuelto">Resuelto</option>
                                <option value="Cerrado">Cerrado</option>
                            </select>
                            <button class="refresh-btn" onclick="cargarTickets()">🔄 Actualizar</button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Email</th>
                                    <th>Asunto</th>
                                    <th>Estado</th>
                                    <th>Prioridad</th>
                                    <th>Fecha</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tickets-tabla">
                                <tr>
                                    <td colspan="8" class="loading">Cargando tickets...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sección Analíticas -->
        <div id="analiticas" class="section">
            <div class="container">
                <h1>📊 Analíticas Web</h1>

                <div class="card">
                    <div class="card-header">
                        <h2>🚀 Google Analytics</h2>
                    </div>

                    <div style="padding: 30px; text-align: center;">
                        <div style="margin-bottom: 30px;">
                            <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="#4285F4" stroke-width="2" style="margin-bottom: 20px;">
                                <path d="M21.21 15.89A10 10 0 1 1 8 2.83"/>
                                <path d="M22 12A10 10 0 0 0 12 2v10z"/>
                            </svg>
                            <h3 style="color: #333; margin-bottom: 15px;">Panel de Analíticas</h3>
                            <p style="color: #666; max-width: 600px; margin: 0 auto 30px;">
                                Accede a las estadísticas completas de tu sitio web en Google Analytics.
                                Visualiza visitas, comportamiento de usuarios, fuentes de tráfico y mucho más.
                            </p>
                        </div>

                        <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-bottom: 30px; text-align: left; max-width: 800px; margin-left: auto; margin-right: auto;">
                            <h4 style="color: #333; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#4285F4" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M12 6v6l4 2"/>
                                </svg>
                                Métricas disponibles en Google Analytics:
                            </h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                <div style="display: flex; align-items: start; gap: 10px;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#34A853" stroke-width="2" style="flex-shrink: 0; margin-top: 2px;">
                                        <polyline points="20 6 9 17 4 12"/>
                                    </svg>
                                    <div>
                                        <strong style="color: #333;">Visitas y usuarios únicos</strong>
                                        <p style="color: #666; font-size: 0.9em; margin: 5px 0 0;">Tráfico en tiempo real y histórico</p>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: start; gap: 10px;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#34A853" stroke-width="2" style="flex-shrink: 0; margin-top: 2px;">
                                        <polyline points="20 6 9 17 4 12"/>
                                    </svg>
                                    <div>
                                        <strong style="color: #333;">Páginas más visitadas</strong>
                                        <p style="color: #666; font-size: 0.9em; margin: 5px 0 0;">Contenido más popular</p>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: start; gap: 10px;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#34A853" stroke-width="2" style="flex-shrink: 0; margin-top: 2px;">
                                        <polyline points="20 6 9 17 4 12"/>
                                    </svg>
                                    <div>
                                        <strong style="color: #333;">Fuentes de tráfico</strong>
                                        <p style="color: #666; font-size: 0.9em; margin: 5px 0 0;">De dónde vienen tus visitantes</p>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: start; gap: 10px;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#34A853" stroke-width="2" style="flex-shrink: 0; margin-top: 2px;">
                                        <polyline points="20 6 9 17 4 12"/>
                                    </svg>
                                    <div>
                                        <strong style="color: #333;">Comportamiento</strong>
                                        <p style="color: #666; font-size: 0.9em; margin: 5px 0 0;">Cómo interactúan los usuarios</p>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: start; gap: 10px;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#34A853" stroke-width="2" style="flex-shrink: 0; margin-top: 2px;">
                                        <polyline points="20 6 9 17 4 12"/>
                                    </svg>
                                    <div>
                                        <strong style="color: #333;">Conversiones</strong>
                                        <p style="color: #666; font-size: 0.9em; margin: 5px 0 0;">Seguimiento de objetivos</p>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: start; gap: 10px;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#34A853" stroke-width="2" style="flex-shrink: 0; margin-top: 2px;">
                                        <polyline points="20 6 9 17 4 12"/>
                                    </svg>
                                    <div>
                                        <strong style="color: #333;">Datos demográficos</strong>
                                        <p style="color: #666; font-size: 0.9em; margin: 5px 0 0;">Ubicación y características</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                            <a href="https://analytics.google.com/analytics/web/"
                               target="_blank"
                               rel="noopener noreferrer"
                               style="display: inline-flex; align-items: center; gap: 10px; background: linear-gradient(135deg, #4285F4 0%, #1a73e8 100%); color: white; padding: 15px 30px; border-radius: 8px; text-decoration: none; font-weight: 600; box-shadow: 0 2px 8px rgba(66, 133, 244, 0.3); transition: transform 0.2s, box-shadow 0.2s;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="20" x2="18" y2="10"/>
                                    <line x1="12" y1="20" x2="12" y2="4"/>
                                    <line x1="6" y1="20" x2="6" y2="14"/>
                                </svg>
                                Abrir Google Analytics
                            </a>

                            <a href="https://analytics.google.com/analytics/web/#/realtime"
                               target="_blank"
                               rel="noopener noreferrer"
                               style="display: inline-flex; align-items: center; gap: 10px; background: linear-gradient(135deg, #34A853 0%, #0d8239 100%); color: white; padding: 15px 30px; border-radius: 8px; text-decoration: none; font-weight: 600; box-shadow: 0 2px 8px rgba(52, 168, 83, 0.3); transition: transform 0.2s, box-shadow 0.2s;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                                </svg>
                                Ver Tiempo Real
                            </a>
                        </div>

                        <div style="margin-top: 40px; padding: 20px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px; text-align: left; max-width: 800px; margin-left: auto; margin-right: auto;">
                            <h4 style="color: #856404; margin: 0 0 10px; display: flex; align-items: center; gap: 10px;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#856404" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <line x1="12" y1="8" x2="12" y2="12"/>
                                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                                </svg>
                                ¿Aún no tienes Google Analytics configurado?
                            </h4>
                            <p style="color: #856404; margin: 0 0 15px;">
                                Sigue estos pasos para empezar a rastrear las visitas de tu sitio:
                            </p>
                            <ol style="color: #856404; margin: 0; padding-left: 20px;">
                                <li style="margin-bottom: 8px;">Ve a <a href="https://analytics.google.com" target="_blank" style="color: #0066cc;">analytics.google.com</a> y crea una cuenta</li>
                                <li style="margin-bottom: 8px;">Crea una propiedad para tu sitio web</li>
                                <li style="margin-bottom: 8px;">Obtén tu ID de medición (formato: G-XXXXXXXXXX)</li>
                                <li>Añade el ID al archivo index.html de tu sitio</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Fin Main Content -->

    <!-- Modal Enviar Email -->
    <div id="modalEmail" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 id="modalEmailTitulo">✉️ Enviar Email</h2>
                <button class="close-modal" onclick="cerrarModalEmail()">✕</button>
            </div>
            <form id="formEmail" onsubmit="enviarEmail(event)">
                <div class="form-group">
                    <label>Destinatarios</label>
                    <div id="destinatarios-list" style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 10px; max-height: 150px; overflow-y: auto;">
                        <!-- Se llenarán dinámicamente -->
                    </div>
                </div>

                <div class="form-group">
                    <label>Asunto</label>
                    <input type="text" id="emailAsunto" class="form-control" required placeholder="Escribe el asunto del email">
                </div>

                <div class="form-group">
                    <label>Mensaje</label>
                    <textarea id="emailMensaje" class="form-control" rows="8" required placeholder="Escribe tu mensaje aquí..."></textarea>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn-secondary" onclick="cerrarModalEmail()">Cancelar</button>
                    <button type="submit" class="btn-primary">📧 Enviar Email</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Compartir en RRSS -->
    <div id="modalRRSS" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 id="modalRRSSTitulo">📱 Compartir en Redes Sociales</h2>
                <button class="close-modal" onclick="cerrarModalRRSS()">✕</button>
            </div>
            <div id="rrss-producto-preview" style="margin-bottom: 20px;">
                <!-- Vista previa del producto -->
            </div>
            <div class="form-group">
                <label>Texto de publicación</label>
                <textarea id="rrssTexto" class="form-control" rows="5" placeholder="Escribe el texto para la publicación..."></textarea>
            </div>
            <div class="form-group">
                <label>Publicar directamente en Instagram</label>
                <div style="background: linear-gradient(135deg, #f09433 0%,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%); padding: 20px; border-radius: 10px; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                        <div style="background: white; padding: 10px; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                            <span style="font-size: 2em;">📷</span>
                        </div>
                        <div style="color: white;">
                            <h3 style="margin: 0 0 5px 0; font-size: 1.1em;">Publicar automáticamente</h3>
                            <p style="margin: 0; font-size: 0.9em; opacity: 0.9;">La publicación se hará directamente en tu cuenta de Instagram Business</p>
                        </div>
                    </div>
                    <button type="button" class="btn-primary" style="width: 100%; background: white; color: #bc1888; font-weight: bold; border: none; padding: 12px;" onclick="publicarEnInstagram()">
                        📷 Publicar en Instagram
                    </button>
                    <div id="instagram-status" style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 5px; color: white; font-size: 0.85em; display: none;">
                        <!-- Estado de la publicación -->
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>O compartir manualmente en otras redes</label>
                <div style="display: flex; gap: 10px;">
                    <button type="button" class="rrss-btn facebook" style="flex: 1;" onclick="compartirEnRRSS('facebook')">
                        👍 Facebook
                    </button>
                    <button type="button" class="rrss-btn twitter" style="flex: 1;" onclick="compartirEnRRSS('twitter')">
                        🐦 Twitter
                    </button>
                </div>
            </div>
            <div style="margin-top: 20px;">
                <button type="button" class="btn-secondary" onclick="cerrarModalRRSS()" style="width: 100%;">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal Detalle de Ticket -->
    <div id="modalTicket" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 id="modalTicketTitulo">Ticket #</h2>
                <button class="close-modal" onclick="cerrarModalTicket()">✕</button>
            </div>
            <div id="ticketDetalleContenido">
                <!-- El contenido se llenará dinámicamente -->
            </div>
        </div>
    </div>

    <!-- Modal Nuevo/Editar Producto -->
    <div id="modalProducto" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalProductoTitulo">Nuevo Producto</h2>
                <button class="close-modal" onclick="cerrarModalProducto()">✕</button>
            </div>
            <form id="formProducto" onsubmit="guardarProducto(event)">
                <input type="hidden" id="productoId" value="">

                <div class="form-group">
                    <label>Nombre del Producto</label>
                    <input type="text" class="form-control" id="productoNombre" required>
                </div>

                <div class="form-group">
                    <label>Precio (€)</label>
                    <input type="number" class="form-control" id="productoPrecio" step="0.01" required>
                </div>

                <div class="form-group">
                    <label>Categoría</label>
                    <select class="form-control" id="productoCategoria" required>
                        <option value="zapatillas">Zapatillas</option>
                        <option value="bolsos">Bolsos</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>URLs de Imágenes</label>
                    <div id="imagenesContainer">
                        <!-- Las imágenes se añadirán aquí dinámicamente -->
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <input type="url" class="form-control" id="nuevaImagenUrl" placeholder="https://ejemplo.com/imagen.jpg">
                        <button type="button" class="btn-primary" onclick="agregarImagen()" style="white-space: nowrap; padding: 10px 20px;">➕ Añadir</button>
                    </div>
                    <small style="color: #666; margin-top: 5px; display: block;">Añade al menos una imagen. Puedes agregar varias para crear un carrusel.</small>
                </div>

                <div class="form-group">
                    <label>Descripción</label>
                    <textarea class="form-control" id="productoDescripcion" required></textarea>
                </div>

                <div class="form-group">
                    <label>Tallas (separadas por coma)</label>
                    <input type="text" class="form-control" id="productoTallas" placeholder="36, 37, 38, 39, 40" required>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="productoNuevo"> Producto Nuevo
                    </label>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="productoDestacado"> Producto Destacado
                    </label>
                </div>

                <div class="action-buttons">
                    <button type="submit" class="btn-primary">💾 Guardar Producto</button>
                    <button type="button" class="btn-secondary" onclick="cerrarModalProducto()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Subir CSV -->
    <div id="modalCSV" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Subir Productos desde CSV</h2>
                <button class="close-modal" onclick="cerrarModalCSV()">✕</button>
            </div>

            <div class="file-upload-area" onclick="document.getElementById('csvFile').click()">
                <input type="file" id="csvFile" accept=".csv" onchange="procesarCSV(event)">
                <div style="font-size: 3em; margin-bottom: 15px;">📄</div>
                <h3>Haz clic para seleccionar un archivo CSV</h3>
                <p style="color: #666; margin-top: 10px; font-size: 0.9em;">
                    Después de cargar el archivo, podrás seleccionar qué columnas importar.<br>
                    <strong>✨ Todos los campos son opcionales.</strong> Los campos vacíos usarán valores por defecto.
                </p>
            </div>

            <div id="csvPreview" style="margin-top: 20px;"></div>

            <div class="action-buttons" style="margin-top: 20px;">
                <button type="button" class="btn-primary" id="btnSubirCSV" onclick="subirCSV()" style="display: none;">📤 Importar Productos</button>
                <button type="button" class="btn-secondary" onclick="cerrarModalCSV()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal Actualizar Productos -->
    <div id="modalActualizarProductos" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🔄 Actualizar Productos desde CSV</h2>
                <button class="close-modal" onclick="cerrarModalActualizarProductos()">✕</button>
            </div>

            <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ff9800;">
                <strong style="color: #e65100;">ℹ️ Sección dedicada a la actualización de STOCK por CSV</strong>
                <p style="color: #666; margin-top: 8px; font-size: 0.9em;">
                    <strong>Esta función SOLO actualiza el stock</strong> de los productos existentes que coincidan con el SKU.<br>
                    <strong style="color: #d32f2f;">NO se añadirán productos nuevos.</strong><br>
                    Solo se actualizará el inventario/stock de las tallas/variantes existentes.<br><br>
                    <strong style="color: #e65100;">Link de actualización:</strong>
                    <a href="https://dropshippingzapatos.com/Csv/All/InventarioShopify.csv" target="_blank" style="color: #1976d2; text-decoration: none; font-weight: 600;">
                        https://dropshippingzapatos.com/Csv/All/InventarioShopify.csv
                    </a>
                </p>
            </div>

            <div class="file-upload-area" onclick="document.getElementById('csvFileActualizar').click()">
                <input type="file" id="csvFileActualizar" accept=".csv" onchange="procesarCSVActualizar(event)">
                <div style="font-size: 3em; margin-bottom: 15px;">🔄</div>
                <h3>Haz clic para seleccionar un archivo CSV</h3>
                <p style="color: #666; margin-top: 10px; font-size: 0.9em;">
                    Los productos existentes con el mismo SKU serán <strong>actualizados</strong>.<br>
                    Productos nuevos serán agregados.
                </p>
            </div>

            <div id="csvPreviewActualizar" style="margin-top: 20px;"></div>

            <div id="vistaPreviaStock" style="margin-top: 20px;"></div>

            <div class="action-buttons" style="margin-top: 20px;">
                <button type="button" class="btn-secondary" id="btnVerVistaPrevia" onclick="verVistaPreviaStock()" style="display: none; background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);">👁️ Ver Vista Previa</button>
                <button type="button" class="btn-primary" id="btnActualizarCSV" onclick="actualizarProductosCSV()" style="display: none;">🔄 Actualizar Stock</button>
                <button type="button" class="btn-secondary" onclick="cerrarModalActualizarProductos()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal Añadir Productos Nuevos -->
    <div id="modalProductosNuevos" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>✨ Añadir Solo Productos Nuevos desde CSV</h2>
                <button class="close-modal" onclick="cerrarModalProductosNuevos()">✕</button>
            </div>

            <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #4caf50;">
                <strong style="color: #2e7d32;">ℹ️ Solo productos nuevos</strong>
                <p style="color: #666; margin-top: 8px; font-size: 0.9em;">
                    Solo se importarán productos que <strong>no existan</strong> en el sistema.<br>
                    Los productos con SKU duplicado serán omitidos automáticamente.
                </p>
                <p style="color: #1976d2; margin-top: 12px; font-size: 0.9em; background: white; padding: 10px; border-radius: 6px;">
                    <strong>🔗 Link para actualización:</strong><br>
                    <a href="http://www.dropshippingzapatos.com/Csv/pablo.martinezruiz@protonmail.com/WishlistShopify.csv"
                       target="_blank"
                       style="color: #1976d2; text-decoration: underline; word-break: break-all;">
                        www.dropshippingzapatos.com/Csv/pablo.martinezruiz@protonmail.com/WishlistShopify.csv
                    </a>
                </p>
            </div>

            <div class="file-upload-area" onclick="document.getElementById('csvFileNuevos').click()">
                <input type="file" id="csvFileNuevos" accept=".csv" onchange="procesarCSVNuevos(event)">
                <div style="font-size: 3em; margin-bottom: 15px;">✨</div>
                <h3>Haz clic para seleccionar un archivo CSV</h3>
                <p style="color: #666; margin-top: 10px; font-size: 0.9em;">
                    Solo se añadirán productos <strong>nuevos</strong>.<br>
                    Los SKU duplicados serán omitidos.
                </p>
            </div>

            <div id="csvPreviewNuevos" style="margin-top: 20px;"></div>

            <div class="action-buttons" style="margin-top: 20px;">
                <button type="button" class="btn-primary" id="btnNuevosCSV" onclick="añadirProductosNuevosCSV()" style="display: none;">✨ Añadir Productos Nuevos</button>
                <button type="button" class="btn-secondary" onclick="cerrarModalProductosNuevos()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal Gestión de Categorías -->
    <div id="modalCategorias" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🏷️ Gestión de Categorías</h2>
                <button class="close-modal" onclick="cerrarModalCategorias()">✕</button>
            </div>

            <div style="margin-bottom: 25px;">
                <h3 style="margin-bottom: 15px;">Añadir Nueva Categoría</h3>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <input type="text" id="nuevaCategoria" class="form-control" placeholder="Nombre de la categoría" style="flex: 1;">
                    <select id="nuevaCategoriaPadre" class="form-control">
                        <option value="">Categoría Principal (sin padre)</option>
                    </select>
                    <button class="btn-primary" onclick="agregarCategoria()">➕ Añadir Categoría</button>
                </div>
            </div>

            <div>
                <h3 style="margin-bottom: 15px;">Categorías Existentes</h3>
                <div id="listaCategorias" style="display: flex; flex-direction: column; gap: 10px;">
                    <!-- Las categorías se cargarán aquí -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nuevo/Editar Descuento -->
    <div id="modalDescuento" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalDescuentoTitulo">Nuevo Descuento</h2>
                <button class="close-modal" onclick="cerrarModalDescuento()">✕</button>
            </div>
            <form id="formDescuento" onsubmit="guardarDescuento(event)">
                <input type="hidden" id="descuentoId" value="">

                <div class="form-group">
                    <label>Nombre del Descuento</label>
                    <input type="text" class="form-control" id="descuentoNombre" placeholder="Ej: Descuento Halloween" required>
                </div>

                <div class="form-group">
                    <label>Tipo de Beneficio</label>
                    <select class="form-control" id="descuentoTipoBeneficioGlobal" onchange="actualizarCamposDescuento()" required>
                        <option value="porcentaje">Descuento Porcentual (%)</option>
                        <option value="cantidad">Descuento por Cantidad (€)</option>
                    </select>
                </div>

                <div class="form-group" id="descuentoPorcentajeContainer">
                    <label>Porcentaje de Descuento (%)</label>
                    <input type="number" class="form-control" id="descuentoPorcentaje" min="0" max="100" step="0.01" placeholder="Ej: 20">
                </div>

                <div class="form-group" id="descuentoCantidadContainer" style="display: none;">
                    <label>Cantidad de Descuento (€)</label>
                    <input type="number" class="form-control" id="descuentoCantidad" min="0" step="0.01" placeholder="Ej: 5">
                    <small style="color: #666;">Se restará esta cantidad fija del total del pedido</small>
                </div>

                <div class="form-group">
                    <label>Tipo de Descuento</label>
                    <select class="form-control" id="descuentoTipo" onchange="actualizarCamposDescuento()" required>
                        <option value="general">General (todos los productos)</option>
                        <option value="categoria">Por Categoría</option>
                        <option value="producto">Por Producto Específico</option>
                        <option value="pedido">Por Monto de Pedido</option>
                    </select>
                </div>

                <div class="form-group" id="descuentoAplicaAContainer" style="display: none;">
                    <label id="descuentoAplicaALabel">Aplicar a:</label>
                    <select class="form-control" id="descuentoAplicaA">
                        <!-- Se llenará dinámicamente -->
                    </select>
                </div>

                <div class="form-group" id="descuentoMontoMinimoContainer" style="display: none;">
                    <label>Monto Mínimo del Pedido (€)</label>
                    <input type="number" class="form-control" id="descuentoMontoMinimo" min="0" step="0.01" placeholder="Ej: 50">
                    <small style="color: #666;">El descuento se aplicará cuando el pedido supere este monto</small>
                </div>

                <div class="form-group" id="descuentoTipoBeneficioContainer" style="display: none;">
                    <label>Tipo de Beneficio</label>
                    <select class="form-control" id="descuentoTipoBeneficio" onchange="actualizarCamposDescuento()">
                        <option value="envio_gratis">Envío Gratuito</option>
                        <option value="descuento">Descuento Porcentual</option>
                    </select>
                    <small style="color: #666;">Envío gratuito o descuento adicional sobre el total</small>
                </div>

                <div class="form-group">
                    <label>Fecha de Inicio (opcional)</label>
                    <input type="datetime-local" class="form-control" id="descuentoFechaInicio">
                </div>

                <div class="form-group">
                    <label>Fecha de Fin (opcional)</label>
                    <input type="datetime-local" class="form-control" id="descuentoFechaFin">
                </div>

                <div class="form-group">
                    <label>Código del Descuento (opcional)</label>
                    <input type="text" class="form-control" id="descuentoCodigo" placeholder="Ej: HALLOWEEN2024">
                    <small style="color: #666;">Si se especifica, el usuario deberá ingresar este código para aplicar el descuento</small>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="descuentoActivo" checked> Descuento Activo
                    </label>
                </div>

                <div class="action-buttons">
                    <button type="submit" class="btn-primary">💾 Guardar Descuento</button>
                    <button type="button" class="btn-secondary" onclick="cerrarModalDescuento()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Detalle de Pedido -->
    <div id="modalPedidoDetalle" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 id="modalPedidoTitulo">Detalles del Pedido</h2>
                <button class="close-modal" onclick="cerrarModalPedido()">✕</button>
            </div>
            <div id="pedidoDetalleContenido">
                <!-- El contenido se cargará dinámicamente -->
            </div>
        </div>
    </div>

    <script>
        // Función para cambiar entre secciones
        function showSection(sectionId) {
            console.log('🔄 Cambiando a sección:', sectionId);

            // Ocultar todas las secciones
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
                section.style.cssText = ''; // Limpiar estilos inline
            });

            // Mostrar la sección seleccionada
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');

                // HACK temporal: Forzar visibilidad para tickets
                if (sectionId === 'tickets') {
                    targetSection.style.display = 'block';
                    targetSection.style.minHeight = '100vh';
                }

                console.log('✅ Sección activada:', sectionId);
            } else {
                console.error('❌ No se encontró la sección:', sectionId);
            }

            // Actualizar el menú activo
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');

            // Cargar datos específicos de la sección
            if (sectionId === 'tickets') {
                cargarTickets();
            } else if (sectionId === 'pedidos') {
                cargarPedidos();
            } else if (sectionId === 'productos') {
                cargarProductos();
            } else if (sectionId === 'descuentos') {
                cargarDescuentos();
            } else if (sectionId === 'clientes') {
                cargarClientes();
            }
        }

        // Verificar sesión al cargar la página
        async function verificarSesion() {
            try {
                const response = await fetch('/api/admin/session', {
                    credentials: 'include'
                });
                if (!response.ok) {
                    window.location.href = '/admin';
                    return false;
                }
                const data = await response.json();
                document.getElementById('username-display').textContent = data.username;
                document.getElementById('user-avatar').textContent = data.username[0].toUpperCase();
                return true;
            } catch (error) {
                window.location.href = '/admin';
                return false;
            }
        }

        // Función de logout
        async function logout() {
            try {
                await fetch('/api/admin/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                window.location.href = '/admin';
            } catch (error) {
                console.error('Error al cerrar sesión:', error);
            }
        }

        // Función para obtener el color del estado
        function getEstadoColor(estado) {
            const colores = {
                'Nuevo Pedido': '#2196f3',
                'Pendiente de Envío': '#ff9800',
                'Enviado': '#9c27b0',
                'En Reparto': '#3f51b5',
                'Entregado': '#4caf50',
                'Cancelado': '#f44336'
            };
            return colores[estado] || '#999';
        }

        // Función para cambiar el estado del pedido
        async function cambiarEstadoPedido(pedidoId, nuevoEstado) {
            try {
                const response = await fetch(`/api/pedidos/${pedidoId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ estado: nuevoEstado })
                });

                if (response.ok) {
                    cargarPedidos();
                } else {
                    alert('Error al actualizar el estado del pedido');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al actualizar el estado del pedido');
            }
        }

        // Función para copiar el Stripe ID al portapapeles
        function copiarStripeId(stripeId) {
            navigator.clipboard.writeText(stripeId).then(() => {
                // Mostrar mensaje de éxito
                const mensaje = document.createElement('div');
                mensaje.textContent = '✓ ID de Stripe copiado al portapapeles';
                mensaje.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #4CAF50;
                    color: white;
                    padding: 15px 25px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    z-index: 100000;
                    font-weight: 500;
                    animation: slideIn 0.3s ease-out;
                `;
                document.body.appendChild(mensaje);

                // Eliminar el mensaje después de 2 segundos
                setTimeout(() => {
                    mensaje.style.animation = 'slideOut 0.3s ease-in';
                    setTimeout(() => mensaje.remove(), 300);
                }, 2000);
            }).catch(err => {
                alert('Error al copiar el ID de Stripe: ' + err);
            });
        }

        // Función para eliminar un pedido con confirmación
        async function eliminarPedido(pedidoId) {
            const pedido = pedidosData.find(p => p.id === pedidoId);
            if (!pedido) return;

            const confirmacion = confirm(
                `¿Estás seguro de que deseas eliminar el pedido #${pedidoId}?\n\n` +
                `Cliente: ${pedido.cliente.nombre}\n` +
                `Total: €${pedido.total.toFixed(2)}\n\n` +
                `Esta acción no se puede deshacer.`
            );

            if (!confirmacion) return;

            try {
                const response = await fetch(`/api/pedidos/${pedidoId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    alert('Pedido eliminado correctamente');
                    cargarPedidos();
                    cargarUltimosPedidosDashboard();
                } else {
                    const data = await response.json();
                    alert('Error al eliminar el pedido: ' + (data.mensaje || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al eliminar el pedido');
            }
        }

        // Variable global para almacenar los pedidos
        let pedidosData = [];

        async function cargarPedidos() {
            try {
                const response = await fetch('/api/pedidos');
                pedidosData = await response.json();

                // Actualizar estadísticas
                document.getElementById('total-pedidos').textContent = pedidosData.length;
                document.getElementById('pedidos-pendientes').textContent =
                    pedidosData.filter(p => p.estado === 'Nuevo Pedido' || p.estado === 'Pendiente de Envío').length;

                const ingresosTotales = pedidosData.reduce((sum, p) => sum + p.total, 0);
                document.getElementById('ingresos-totales').textContent =
                    '€' + ingresosTotales.toFixed(2);

                // Mostrar pedidos resumidos
                const listaPedidos = document.getElementById('pedidos-lista');

                if (pedidosData.length === 0) {
                    listaPedidos.innerHTML = '<div class="no-pedidos">No hay pedidos todavía</div>';
                    return;
                }

                listaPedidos.innerHTML = pedidosData
                    .sort((a, b) => new Date(b.fecha) - new Date(a.fecha))
                    .map(pedido => {
                        const fecha = new Date(pedido.fecha);
                        const fechaFormateada = fecha.toLocaleDateString('es-ES', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric'
                        });
                        const horaFormateada = fecha.toLocaleTimeString('es-ES', {
                            hour: '2-digit',
                            minute: '2-digit'
                        });

                        return `
                        <div class="pedido-card-resumido" style="border-left-color: ${getEstadoColor(pedido.estado)};">
                            <div style="display: grid; grid-template-columns: auto 1fr auto auto auto; gap: 20px; align-items: center;">
                                <div onclick="abrirModalPedido(${pedido.id})" style="cursor: pointer;">
                                    <div class="pedido-id" style="font-size: 1.1em; font-weight: 600; color: #667eea;">
                                        #${pedido.id}
                                    </div>
                                    <div style="font-size: 0.85em; color: #999; margin-top: 3px;">
                                        📅 ${fechaFormateada}<br>🕒 ${horaFormateada}
                                    </div>
                                </div>

                                <div onclick="abrirModalPedido(${pedido.id})" style="cursor: pointer;">
                                    <div style="font-weight: 600; color: #333; margin-bottom: 5px;">
                                        👤 ${pedido.cliente.nombre}
                                    </div>
                                    <div style="font-size: 0.85em; color: #666;">
                                        📧 ${pedido.cliente.email}<br>
                                        📞 ${pedido.cliente.telefono}
                                    </div>
                                </div>

                                <div style="text-align: center;" onclick="abrirModalPedido(${pedido.id})">
                                    <span class="estado" style="background: ${getEstadoColor(pedido.estado)}; color: white; padding: 6px 14px; border-radius: 20px; font-size: 0.8em; white-space: nowrap; cursor: pointer;">
                                        ${pedido.estado}
                                    </span>
                                </div>

                                <div style="text-align: right;" onclick="abrirModalPedido(${pedido.id})">
                                    <div style="font-size: 1.4em; font-weight: bold; color: #667eea; cursor: pointer;">
                                        €${pedido.total.toFixed(2)}
                                    </div>
                                    <div style="font-size: 0.75em; color: #999; margin-top: 3px;">
                                        ${pedido.items.length} producto${pedido.items.length !== 1 ? 's' : ''}
                                    </div>
                                </div>

                                <div style="text-align: right;">
                                    <button class="btn-small btn-delete" onclick="event.stopPropagation(); eliminarPedido(${pedido.id})" style="padding: 8px 12px; font-size: 0.85em;">
                                        🗑️ Borrar
                                    </button>
                                </div>
                            </div>
                        </div>
                    `}).join('');
            } catch (error) {
                console.error('Error al cargar pedidos:', error);
                document.getElementById('pedidos-lista').innerHTML =
                    '<div class="no-pedidos">Error al cargar pedidos. Asegúrate de que el servidor esté corriendo.</div>';
            }
        }

        // Funciones para el modal de pedido
        function abrirModalPedido(pedidoId) {
            const pedido = pedidosData.find(p => p.id === pedidoId);
            if (!pedido) return;

            const fecha = new Date(pedido.fecha);
            const fechaFormateada = fecha.toLocaleDateString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            const horaFormateada = fecha.toLocaleTimeString('es-ES', {
                hour: '2-digit',
                minute: '2-digit'
            });

            document.getElementById('modalPedidoTitulo').textContent = `Pedido #${pedido.id}`;

            document.getElementById('pedidoDetalleContenido').innerHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div>
                            <div style="font-size: 0.9em; color: #666;">
                                📅 ${fechaFormateada} • 🕒 ${horaFormateada}
                            </div>
                        </div>
                        <span class="estado" style="background: ${getEstadoColor(pedido.estado)}; color: white; padding: 8px 16px; border-radius: 20px; font-size: 0.9em;">
                            ${pedido.estado}
                        </span>
                    </div>

                    <div style="margin-top: 15px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">Cambiar Estado:</label>
                        <select
                            onchange="cambiarEstadoPedido(${pedido.id}, this.value)"
                            style="width: 100%; padding: 10px; border: 2px solid #667eea; border-radius: 8px; font-size: 0.95em; cursor: pointer; background: white;"
                        >
                            <option value="">Seleccionar nuevo estado...</option>
                            <option value="Nuevo Pedido">Nuevo Pedido</option>
                            <option value="Pendiente de Envío">Pendiente de Envío</option>
                            <option value="Enviado">Enviado</option>
                            <option value="En Reparto">En Reparto</option>
                            <option value="Entregado">Entregado</option>
                            <option value="Cancelado">Cancelado</option>
                        </select>
                    </div>
                </div>

                <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #e8eaf6;">
                    <h3 style="color: #667eea; margin-bottom: 15px; font-size: 1.2em;">👤 Datos del Cliente</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <div>
                            <strong style="color: #666; font-size: 0.85em;">Nombre:</strong>
                            <div style="color: #333; margin-top: 5px;">${pedido.cliente.nombre}</div>
                        </div>
                        <div>
                            <strong style="color: #666; font-size: 0.85em;">Email:</strong>
                            <div style="color: #333; margin-top: 5px;">${pedido.cliente.email}</div>
                        </div>
                        <div>
                            <strong style="color: #666; font-size: 0.85em;">Teléfono:</strong>
                            <div style="color: #333; margin-top: 5px;">${pedido.cliente.telefono}</div>
                        </div>
                        ${pedido.paymentIntentId ? `
                        <div>
                            <strong style="color: #666; font-size: 0.85em;">💳 Stripe ID:</strong>
                            <div style="margin-top: 5px;">
                                <span onclick="copiarStripeId('${pedido.paymentIntentId}')"
                                      style="background: #f0f4ff; color: #5469d4; padding: 6px 12px; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 0.85em; cursor: pointer; display: inline-block; transition: all 0.2s;"
                                      onmouseover="this.style.background='#e0ebff'; this.style.transform='scale(1.02)'"
                                      onmouseout="this.style.background='#f0f4ff'; this.style.transform='scale(1)'"
                                      title="Clic para copiar">
                                    ${pedido.paymentIntentId}
                                </span>
                            </div>
                        </div>
                        ` : ''}
                    </div>

                    ${pedido.cliente.direccion ? `
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <h4 style="color: #667eea; margin-bottom: 10px; font-size: 1em;">📍 Dirección de Envío</h4>
                        <div style="margin-bottom: 8px;"><strong>Calle:</strong> ${pedido.cliente.direccion}</div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                            ${pedido.cliente.ciudad ? `<div><strong>Ciudad:</strong> ${pedido.cliente.ciudad}</div>` : ''}
                            ${pedido.cliente.provincia ? `<div><strong>Provincia:</strong> ${pedido.cliente.provincia}</div>` : ''}
                            ${pedido.cliente.codigoPostal ? `<div><strong>C.P.:</strong> ${pedido.cliente.codigoPostal}</div>` : ''}
                        </div>
                    </div>
                    ` : ''}
                </div>

                <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #e8eaf6;">
                    <h3 style="color: #667eea; margin-bottom: 15px; font-size: 1.2em;">📦 Productos</h3>
                    <div>
                        ${pedido.items.map(item => {
                            const precioUnitario = item.descuento ? item.descuento.precioConDescuento : item.precio;
                            return `
                            <div style="padding: 15px 0; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #333; margin-bottom: 5px;">${item.nombre}</div>
                                    <div style="font-size: 0.9em; color: #666;">
                                        Cantidad: ${item.cantidad} • Talla: ${item.talla}
                                        ${item.descuento ? `<br><span style="color: #f44336; font-weight: 600;">🎟️ ${item.descuento.nombre} (-${item.descuento.porcentaje}%)</span>` : ''}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: 600; color: #667eea; font-size: 1.1em;">
                                        €${(precioUnitario * item.cantidad).toFixed(2)}
                                    </div>
                                    ${item.descuento ? `
                                    <div style="font-size: 0.85em; color: #999; text-decoration: line-through; margin-top: 3px;">
                                        €${(item.precio * item.cantidad).toFixed(2)}
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                </div>

                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; color: white; text-align: right;">
                    <div style="font-size: 1.1em; margin-bottom: 5px;">Total del Pedido</div>
                    <div style="font-size: 2em; font-weight: bold;">€${pedido.total.toFixed(2)}</div>
                </div>
            `;

            document.getElementById('modalPedidoDetalle').classList.add('show');
        }

        function cerrarModalPedido() {
            document.getElementById('modalPedidoDetalle').classList.remove('show');
        }

        // Función para cargar últimos pedidos en el dashboard
        async function cargarUltimosPedidosDashboard() {
            try {
                const response = await fetch('/api/pedidos');
                const pedidos = await response.json();
                const ultimosPedidos = pedidos
                    .sort((a, b) => new Date(b.fecha) - new Date(a.fecha))
                    .slice(0, 5); // Mostrar solo los últimos 5 pedidos

                const container = document.getElementById('ultimos-pedidos-dashboard');

                if (ultimosPedidos.length === 0) {
                    container.innerHTML = '<div class="no-pedidos" style="padding: 20px;">No hay pedidos todavía</div>';
                    return;
                }

                container.innerHTML = ultimosPedidos.map(pedido => {
                    const fecha = new Date(pedido.fecha);
                    const fechaFormateada = fecha.toLocaleDateString('es-ES', {
                        day: '2-digit',
                        month: '2-digit'
                    });

                    return `
                        <div class="pedido-card-resumido" style="border-left-color: ${getEstadoColor(pedido.estado)}; padding: 15px; margin-bottom: 10px;" onclick="abrirModalPedido(${pedido.id})">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span class="pedido-id" style="font-size: 0.95em;">#${pedido.id}</span>
                                <span style="font-size: 0.85em; color: #999;">📅 ${fechaFormateada}</span>
                            </div>
                            <div style="font-size: 0.85em; color: #666; margin-bottom: 8px;">
                                👤 ${pedido.cliente.nombre}
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span class="estado" style="background: ${getEstadoColor(pedido.estado)}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.7em;">
                                    ${pedido.estado}
                                </span>
                                <span style="font-size: 1.1em; font-weight: bold; color: #667eea;">
                                    €${pedido.total.toFixed(2)}
                                </span>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error al cargar últimos pedidos:', error);
                document.getElementById('ultimos-pedidos-dashboard').innerHTML =
                    '<div class="no-pedidos" style="color: #f44336; padding: 20px;">Error al cargar pedidos</div>';
            }
        }

        // Gestión de Productos
        let productosData = [];
        let csvData = [];
        let csvHeaders = []; // Encabezados del CSV
        let csvMapping = {}; // Mapeo de columnas CSV a campos de producto
        let csvReemplazar = false; // Opción: reemplazar productos existentes
        let csvSoloNuevos = false; // Opción: solo importar productos nuevos
        let categoriasData = [];
        let productosFiltrados = [];
        let descuentosData = [];
        let imagenesProducto = []; // Array temporal para las imágenes del producto

        // Variables de paginación
        let paginaActual = 1;
        const productosPorPagina = 9;

        // Columnas a excluir del desplegable de mapeo
        const columnasExcluidas = [
            'Status', 'Handle',
            'Option2 Name', 'Option2 Value', 'Option3 Name', 'Option3 Value',
            'Variant Inventory Tracker', 'Variant Inventory Policy', 'Variant Fulfillment Service',
            'Variant Compare At Price', 'Variant Requires Shipping', 'Variant Taxable', 'Variant Barcode',
            'Image Alt Text', 'Gift Card', 'SEO Title', 'SEO Description',
            'Google Shopping / Google Product Category', 'Google Shopping / Gender', 'Google Shopping / Age Group',
            'Google Shopping / MPN', 'Google Shopping / AdWords Grouping', 'Google Shopping / AdWords Labels',
            'Google Shopping / Condition', 'Google Shopping / Custom Product',
            'Google Shopping / Custom Label 0', 'Google Shopping / Custom Label 1', 'Google Shopping / Custom Label 2',
            'Google Shopping / Custom Label 3', 'Google Shopping / Custom Label 4',
            'Variant Image', 'Variant Weight Unit', 'Variant Tax Code',
            'Price / Internacional', 'Compare At Price / Internacional'
        ];

        async function cargarProductos() {
            try {
                const response = await fetch('/api/productos');
                productosData = await response.json();
                productosFiltrados = productosData;

                // Cargar categorías si aún no están cargadas
                if (categoriasData.length === 0) {
                    try {
                        const catResponse = await fetch('/api/categorias');
                        categoriasData = await catResponse.json();
                    } catch (error) {
                        console.error('Error al cargar categorías:', error);
                    }
                }

                // Actualizar filtro de categorías
                actualizarFiltroCategorias();

                // Renderizar productos
                renderizarProductos(productosFiltrados);
            } catch (error) {
                console.error('Error al cargar productos:', error);
                document.getElementById('productos-grid').innerHTML =
                    '<div class="loading">Error al cargar productos</div>';
            }
        }

        // ==================== ACTUALIZACIÓN AUTOMÁTICA ====================

        async function cargarUltimaActualizacion() {
            try {
                const response = await fetch('/api/productos/ultima-actualizacion');
                const data = await response.json();
                mostrarUltimaActualizacion(data);
            } catch (error) {
                console.error('Error al cargar última actualización:', error);
                document.getElementById('ultima-actualizacion-texto').textContent = 'Error al cargar';
            }
        }

        function mostrarUltimaActualizacion(data) {
            const displayElement = document.getElementById('ultima-actualizacion-display');
            const textoElement = document.getElementById('ultima-actualizacion-texto');

            if (!data.ultimaActualizacion || data.estado === 'nunca') {
                textoElement.textContent = 'Nunca actualizado';
                displayElement.style.background = '#fff3cd';
                displayElement.style.borderLeftColor = '#ffc107';
                return;
            }

            const fecha = new Date(data.ultimaActualizacion);
            const ahora = new Date();
            const diff = ahora - fecha;
            const minutos = Math.floor(diff / 60000);
            const horas = Math.floor(minutos / 60);
            const dias = Math.floor(horas / 24);

            let tiempoTexto;
            if (minutos < 1) {
                tiempoTexto = 'Hace menos de 1 minuto';
            } else if (minutos < 60) {
                tiempoTexto = `Hace ${minutos} minuto${minutos > 1 ? 's' : ''}`;
            } else if (horas < 24) {
                tiempoTexto = `Hace ${horas} hora${horas > 1 ? 's' : ''}`;
            } else {
                tiempoTexto = `Hace ${dias} día${dias > 1 ? 's' : ''}`;
            }

            const fechaFormateada = fecha.toLocaleString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            if (data.estado === 'exito') {
                textoElement.innerHTML = `
                    <div>${tiempoTexto}</div>
                    <div style="font-size: 0.8em; color: #666; margin-top: 3px;">${fechaFormateada}</div>
                    <div style="font-size: 0.75em; color: #4caf50; margin-top: 3px;">✓ ${data.productosActualizados} productos actualizados</div>
                `;
                displayElement.style.background = '#e8f5e9';
                displayElement.style.borderLeftColor = '#4caf50';
            } else if (data.estado === 'error') {
                textoElement.innerHTML = `
                    <div>${tiempoTexto}</div>
                    <div style="font-size: 0.8em; color: #666; margin-top: 3px;">${fechaFormateada}</div>
                    <div style="font-size: 0.75em; color: #f44336; margin-top: 3px;">✗ Error: ${data.error || 'Desconocido'}</div>
                `;
                displayElement.style.background = '#ffebee';
                displayElement.style.borderLeftColor = '#f44336';
            } else if (data.estado === 'en_proceso') {
                textoElement.innerHTML = `
                    <div>Actualizando...</div>
                    <div style="font-size: 0.8em; color: #666; margin-top: 3px;">Por favor espera</div>
                `;
                displayElement.style.background = '#fff3cd';
                displayElement.style.borderLeftColor = '#ffc107';
            }
        }

        async function forzarActualizacion() {
            if (!confirm('¿Deseas forzar una actualización de productos ahora?')) {
                return;
            }

            const displayElement = document.getElementById('ultima-actualizacion-display');
            const textoElement = document.getElementById('ultima-actualizacion-texto');

            textoElement.textContent = 'Actualizando...';
            displayElement.style.background = '#fff3cd';
            displayElement.style.borderLeftColor = '#ffc107';

            try {
                const response = await fetch('/api/productos/actualizar-ahora', {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    mostrarUltimaActualizacion(data);
                    alert(`Actualización completada: ${data.productosActualizados} productos actualizados`);
                    cargarProductos(); // Recargar productos en el dashboard
                } else {
                    throw new Error('Error en la actualización');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al forzar actualización. Intenta de nuevo.');
                cargarUltimaActualizacion(); // Recargar el estado
            }
        }

        // Actualizar el display cada 30 segundos
        setInterval(cargarUltimaActualizacion, 30000);

        // ==================== FIN ACTUALIZACIÓN AUTOMÁTICA ====================

        // Función para obtener la ruta completa de categorías
        function obtenerRutaCategoria(nombreCategoria) {
            const categoria = categoriasData.find(c => c.nombre === nombreCategoria);
            if (!categoria) {
                return nombreCategoria.charAt(0).toUpperCase() + nombreCategoria.slice(1);
            }

            let ruta = [categoria.nombre.charAt(0).toUpperCase() + categoria.nombre.slice(1)];
            let categoriaActual = categoria;

            // Subir por la jerarquía hasta llegar a la raíz
            while (categoriaActual.parentId) {
                const categoriaPadre = categoriasData.find(c => c.id === categoriaActual.parentId);
                if (categoriaPadre) {
                    ruta.unshift(categoriaPadre.nombre.charAt(0).toUpperCase() + categoriaPadre.nombre.slice(1));
                    categoriaActual = categoriaPadre;
                } else {
                    break;
                }
            }

            return ruta.join(' › ');
        }

        // Función para obtener el color de la categoría según sea Mujer/Hombre
        function obtenerColorCategoria(nombreCategoria) {
            const rutaCategoria = obtenerRutaCategoria(nombreCategoria).toLowerCase();

            if (rutaCategoria.includes('mujer')) {
                return '#e91e63'; // Rosa
            } else if (rutaCategoria.includes('hombre')) {
                return '#2196f3'; // Azul
            }
            return '#667eea'; // Color por defecto
        }

        function renderizarProductos(productos) {
            const productosGrid = document.getElementById('productos-grid');

            if (productos.length === 0) {
                productosGrid.innerHTML = '<div class="loading">No hay productos disponibles</div>';
                document.getElementById('paginacion-productos').innerHTML = '';
                return;
            }

            // Calcular productos para la página actual
            const totalPaginas = Math.ceil(productos.length / productosPorPagina);
            const inicio = (paginaActual - 1) * productosPorPagina;
            const fin = inicio + productosPorPagina;
            const productosPagina = productos.slice(inicio, fin);

            productosGrid.innerHTML = productosPagina.map(producto => {
                // Función para obtener imagen principal (soporte variantes y formato antiguo)
                const obtenerImagenPrincipal = () => {
                    // Prioridad 1: Variantes (nuevo formato)
                    if (producto.variantes && producto.variantes.length > 0) {
                        const primeraVariante = producto.variantes[0];
                        if (primeraVariante.imagenes && primeraVariante.imagenes.length > 0) {
                            return primeraVariante.imagenes[0];
                        }
                    }
                    // Prioridad 2: Imagenes directas en el producto (formato antiguo)
                    if (producto.imagenes && producto.imagenes.length > 0) {
                        return producto.imagenes[0];
                    }
                    // Prioridad 3: Imagen única (muy antiguo)
                    if (producto.imagen) {
                        return producto.imagen;
                    }
                    // Fallback: placeholder
                    return 'https://via.placeholder.com/300x400?text=Sin+Imagen';
                };

                const imagenPrincipal = obtenerImagenPrincipal();

                // Contar todas las imágenes de todas las variantes
                let totalImagenes = 0;
                if (producto.variantes && producto.variantes.length > 0) {
                    totalImagenes = producto.variantes.reduce((sum, v) =>
                        sum + (v.imagenes ? v.imagenes.length : 0), 0);
                } else if (producto.imagenes) {
                    totalImagenes = producto.imagenes.length;
                }
                const tieneVariasImagenes = totalImagenes > 1;

                return `
                <div class="producto-card" data-producto-id="${producto.id}">
                    <input type="checkbox" class="producto-checkbox" data-producto-id="${producto.id}" onchange="actualizarContadorSeleccionados()" style="position: absolute; top: 10px; left: 10px; width: 20px; height: 20px; cursor: pointer; z-index: 10;">
                    <img src="${imagenPrincipal}" alt="${producto.nombre}" class="producto-imagen">
                    ${tieneVariasImagenes ? `<div style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.8em;">📷 ${totalImagenes}</div>` : ''}
                    <div class="producto-info">
                        <div class="producto-nombre">${producto.nombre}</div>
                        <div class="producto-precio">€${producto.precio.toFixed(2)}</div>
                        <span class="producto-categoria" title="${obtenerRutaCategoria(producto.categoria)}" style="color: ${obtenerColorCategoria(producto.categoria)};">${obtenerRutaCategoria(producto.categoria)}</span>
                        ${producto.nuevo ? '<span class="producto-categoria" style="background: #ffeb3b; color: #f57f17;">NUEVO</span>' : ''}
                        <div style="font-size: 0.85em; color: #666; margin-top: 8px;">${producto.descripcion}</div>
                    </div>
                    <div class="producto-actions">
                        <button class="btn-small btn-edit" onclick="editarProducto(${producto.id})">✏️ Editar</button>
                        <button class="btn-small btn-delete" onclick="eliminarProducto(${producto.id})">🗑️ Eliminar</button>
                    </div>
                </div>
            `}).join('');

            // Renderizar controles de paginación
            renderizarPaginacion(productos.length, totalPaginas);
        }

        function renderizarPaginacion(totalProductos, totalPaginas) {
            const paginacionDiv = document.getElementById('paginacion-productos');

            if (totalPaginas <= 1) {
                paginacionDiv.innerHTML = '';
                return;
            }

            let paginasHTML = '';

            // Botón anterior
            paginasHTML += `
                <button onclick="cambiarPagina(${paginaActual - 1})"
                        ${paginaActual === 1 ? 'disabled' : ''}
                        class="btn-paginacion">
                    ← Anterior
                </button>
            `;

            // Páginas numeradas
            const rango = 2; // Mostrar 2 páginas a cada lado de la actual
            let inicio = Math.max(1, paginaActual - rango);
            let fin = Math.min(totalPaginas, paginaActual + rango);

            // Primera página
            if (inicio > 1) {
                paginasHTML += `<button onclick="cambiarPagina(1)" class="btn-paginacion">1</button>`;
                if (inicio > 2) {
                    paginasHTML += `<span style="padding: 0 10px; color: #666;">...</span>`;
                }
            }

            // Páginas del rango
            for (let i = inicio; i <= fin; i++) {
                paginasHTML += `
                    <button onclick="cambiarPagina(${i})"
                            class="btn-paginacion ${i === paginaActual ? 'active' : ''}">
                        ${i}
                    </button>
                `;
            }

            // Última página
            if (fin < totalPaginas) {
                if (fin < totalPaginas - 1) {
                    paginasHTML += `<span style="padding: 0 10px; color: #666;">...</span>`;
                }
                paginasHTML += `<button onclick="cambiarPagina(${totalPaginas})" class="btn-paginacion">${totalPaginas}</button>`;
            }

            // Botón siguiente
            paginasHTML += `
                <button onclick="cambiarPagina(${paginaActual + 1})"
                        ${paginaActual === totalPaginas ? 'disabled' : ''}
                        class="btn-paginacion">
                    Siguiente →
                </button>
            `;

            // Info de productos
            const inicio_num = (paginaActual - 1) * productosPorPagina + 1;
            const fin_num = Math.min(paginaActual * productosPorPagina, totalProductos);

            paginacionDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 30px; flex-wrap: wrap; gap: 20px;">
                    <div style="color: #666; font-size: 0.9em;">
                        Mostrando ${inicio_num}-${fin_num} de ${totalProductos} productos
                    </div>
                    <div style="display: flex; gap: 5px; align-items: center; flex-wrap: wrap;">
                        ${paginasHTML}
                    </div>
                </div>
            `;
        }

        function cambiarPagina(nuevaPagina) {
            paginaActual = nuevaPagina;
            renderizarProductos(productosFiltrados);
            // Scroll suave al inicio de productos
            document.getElementById('productos-grid').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Funciones para gestionar imágenes del producto
        function agregarImagen() {
            const url = document.getElementById('nuevaImagenUrl').value.trim();
            if (!url) {
                alert('Por favor ingresa una URL de imagen válida');
                return;
            }

            imagenesProducto.push(url);
            document.getElementById('nuevaImagenUrl').value = '';
            renderizarImagenes();
        }

        function eliminarImagen(index) {
            imagenesProducto.splice(index, 1);
            renderizarImagenes();
        }

        function renderizarImagenes() {
            const container = document.getElementById('imagenesContainer');

            if (imagenesProducto.length === 0) {
                container.innerHTML = '<div style="padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center; color: #999;">No hay imágenes añadidas</div>';
                return;
            }

            container.innerHTML = imagenesProducto.map((url, index) => `
                <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 8px;">
                    <img src="${url}" alt="Imagen ${index + 1}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 6px;">
                    <div style="flex: 1; font-size: 0.85em; color: #666; word-break: break-all;">${url}</div>
                    <button type="button" class="btn-small btn-delete" onclick="eliminarImagen(${index})" style="padding: 5px 10px;">🗑️</button>
                </div>
            `).join('');
        }

        // Función para cargar últimos productos en el dashboard
        async function cargarUltimosProductosDashboard() {
            try {
                const response = await fetch('/api/productos');
                const productos = await response.json();
                const ultimosProductos = productos
                    .sort((a, b) => b.id - a.id)
                    .slice(0, 4); // Mostrar solo los últimos 4 productos

                const container = document.getElementById('ultimos-productos-dashboard');

                if (ultimosProductos.length === 0) {
                    container.innerHTML = '<div class="no-pedidos" style="padding: 20px;">No hay productos todavía</div>';
                    return;
                }

                container.innerHTML = ultimosProductos.map(producto => {
                    // Obtener imagen principal del producto con variantes
                    const obtenerImagen = () => {
                        if (producto.variantes && producto.variantes.length > 0 &&
                            producto.variantes[0].imagenes && producto.variantes[0].imagenes.length > 0) {
                            return producto.variantes[0].imagenes[0];
                        }
                        if (producto.imagenes && producto.imagenes.length > 0) {
                            return producto.imagenes[0];
                        }
                        if (producto.imagen) {
                            return producto.imagen;
                        }
                        return 'https://via.placeholder.com/300x400?text=Sin+Imagen';
                    };
                    const imagenPrincipal = obtenerImagen();
                    return `
                    <div class="producto-card" style="cursor: pointer; transition: all 0.3s;" onclick="showSection('productos')">
                        <img src="${imagenPrincipal}" alt="${producto.nombre}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 10px 10px 0 0;">
                        <div style="padding: 12px;">
                            <div style="font-weight: 600; font-size: 0.9em; color: #333; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                ${producto.nombre}
                            </div>
                            <div style="color: #667eea; font-size: 1.1em; font-weight: bold; margin-bottom: 5px;">
                                €${producto.precio.toFixed(2)}
                            </div>
                            <span class="producto-categoria" style="font-size: 0.75em; color: ${obtenerColorCategoria(producto.categoria)};" title="${obtenerRutaCategoria(producto.categoria)}">${obtenerRutaCategoria(producto.categoria)}</span>
                            ${producto.nuevo ? '<span class="producto-categoria" style="background: #ffeb3b; color: #f57f17; font-size: 0.7em; margin-left: 5px;">NUEVO</span>' : ''}
                        </div>
                    </div>
                `}).join('');
            } catch (error) {
                console.error('Error al cargar últimos productos:', error);
                document.getElementById('ultimos-productos-dashboard').innerHTML =
                    '<div class="no-pedidos" style="color: #f44336; padding: 20px;">Error al cargar productos</div>';
            }
        }

        function actualizarFiltroCategorias() {
            const filterSelect = document.getElementById('filterCategoria');

            // Mostrar TODAS las categorías, no solo las que tienen productos
            const categoriasPrincipales = categoriasData.filter(c => !c.parentId);
            const subcategorias = categoriasData.filter(c => c.parentId);

            filterSelect.innerHTML = '<option value="">Todas las categorías</option>';

            // Añadir categorías principales
            categoriasPrincipales.forEach(cat => {
                filterSelect.innerHTML += `<option value="${cat.nombre}">📁 ${cat.nombre.charAt(0).toUpperCase() + cat.nombre.slice(1)}</option>`;

                // Añadir subcategorías de esta categoría
                const subs = subcategorias.filter(s => s.parentId === cat.id);
                subs.forEach(sub => {
                    filterSelect.innerHTML += `<option value="${sub.nombre}">  └─ ${sub.nombre.charAt(0).toUpperCase() + sub.nombre.slice(1)}</option>`;
                });
            });
        }

        function filtrarProductos() {
            const searchTerm = document.getElementById('searchProducto').value.toLowerCase();
            const categoriaFilter = document.getElementById('filterCategoria').value;

            productosFiltrados = productosData.filter(producto => {
                const matchSearch = producto.nombre.toLowerCase().includes(searchTerm) ||
                                  producto.descripcion.toLowerCase().includes(searchTerm);
                const matchCategoria = !categoriaFilter || producto.categoria === categoriaFilter;

                return matchSearch && matchCategoria;
            });

            // Resetear a la primera página cuando se filtra
            paginaActual = 1;
            renderizarProductos(productosFiltrados);
        }

        // Modales
        async function abrirModalProducto() {
            document.getElementById('modalProductoTitulo').textContent = 'Nuevo Producto';
            document.getElementById('formProducto').reset();
            document.getElementById('productoId').value = '';

            // Limpiar array de imágenes
            imagenesProducto = [];
            renderizarImagenes();

            // Cargar categorías en el select
            await cargarCategoriasEnSelect();

            document.getElementById('modalProducto').classList.add('show');
        }

        async function cargarCategoriasEnSelect() {
            try {
                const response = await fetch('/api/categorias');
                const cats = await response.json();

                const select = document.getElementById('productoCategoria');
                select.innerHTML = cats.map(cat =>
                    `<option value="${cat.nombre}">${cat.nombre.charAt(0).toUpperCase() + cat.nombre.slice(1)}</option>`
                ).join('');
            } catch (error) {
                console.error('Error al cargar categorías:', error);
            }
        }

        function cerrarModalProducto() {
            document.getElementById('modalProducto').classList.remove('show');
        }

        function abrirModalCSV() {
            document.getElementById('csvFile').value = '';
            document.getElementById('csvPreview').innerHTML = '';
            document.getElementById('btnSubirCSV').style.display = 'none';
            document.getElementById('modalCSV').classList.add('show');
        }

        function cerrarModalCSV() {
            document.getElementById('modalCSV').classList.remove('show');
            csvData = [];
            csvHeaders = [];
            csvMapping = {};
            csvReemplazar = false;
            csvSoloNuevos = false;
        }

        // ==================== MODAL ACTUALIZAR PRODUCTOS ====================
        function abrirModalActualizarProductos() {
            document.getElementById('csvPreviewActualizar').innerHTML = '';
            document.getElementById('btnActualizarCSV').style.display = 'none';
            document.getElementById('modalActualizarProductos').classList.add('show');
        }

        function cerrarModalActualizarProductos() {
            document.getElementById('modalActualizarProductos').classList.remove('show');
            csvData = [];
            csvHeaders = [];
            csvMapping = {};
            document.getElementById('csvPreviewActualizar').innerHTML = '';
            document.getElementById('vistaPreviaStock').innerHTML = '';
            document.getElementById('btnVerVistaPrevia').style.display = 'none';
            document.getElementById('btnActualizarCSV').style.display = 'none';
        }

        function procesarCSVActualizar(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim());

                    if (lines.length < 2) {
                        alert('El archivo CSV debe contener al menos una fila de encabezados y una de datos');
                        return;
                    }

                    csvHeaders = parseCSVLine(lines[0]);
                    csvData = [];
                    for (let i = 1; i < lines.length; i++) {
                        const values = parseCSVLine(lines[i]);
                        const row = {};
                        csvHeaders.forEach((header, index) => {
                            row[header] = values[index] || '';
                        });
                        csvData.push(row);
                    }

                    console.log('CSV actualizar procesado:', csvData.length, 'filas');
                    csvMapping = autoMapearColumnas(csvHeaders);
                    mostrarInterfazMapeoActualizar();
                } catch (error) {
                    console.error('Error procesando CSV:', error);
                    alert('Error al procesar el archivo CSV: ' + error.message);
                }
            };

            reader.readAsText(file, 'UTF-8');
        }

        function mostrarInterfazMapeoActualizar() {
            const camposProducto = [
                { key: 'sku', label: 'SKU (Código de Producto) ⭐' },
                { key: 'talla', label: 'Talla (Option1 Value) ⭐' },
                { key: 'stock', label: 'Stock Disponible (Available) ⭐' }
            ];

            // Mapeo automático por defecto - soporta múltiples formatos de CSV
            const mapeoAutomatico = {
                'sku': ['SKU', 'Variant SKU', 'sku'],
                'talla': ['Option1 Value', 'Talla', 'talla', 'option1Value'],
                'stock': ['Available', 'Variant Inventory Qty', 'Stock', 'stock', 'available']
            };

            // Aplicar mapeo automático si las columnas existen
            Object.keys(mapeoAutomatico).forEach(key => {
                const posiblesColumnas = mapeoAutomatico[key];
                for (const columnaCSV of posiblesColumnas) {
                    if (csvHeaders.includes(columnaCSV)) {
                        csvMapping[key] = columnaCSV;
                        break; // Usar la primera coincidencia
                    }
                }
            });

            // Filtrar columnas excluidas del desplegable
            const headersFiltrados = csvHeaders.filter(h => !columnasExcluidas.includes(h));
            const opcionesColumnas = `<option value="">-- No importar --</option>${headersFiltrados.map(h => `<option value="${h}">${h}</option>`).join('')}`;

            const htmlMapeo = `
                <div style="background: #fff3e0; padding: 20px; border-radius: 10px; margin-top: 20px; border-left: 4px solid #ff9800;">
                    <h3 style="color: #ff6f00; margin-bottom: 15px;">🔄 Configurar Actualización de Stock</h3>
                    <p style="color: #666; margin-bottom: 20px;">Se detectaron ${csvData.length} filas y ${csvHeaders.length} columnas.<br><strong>Modo: Actualizar SOLO stock de productos existentes</strong> - Solo se actualizará el stock de las tallas/variantes de productos que coincidan con el SKU. NO se añadirán productos nuevos.<br><strong style="color: #ff9800;">✓ Mapeo automático aplicado</strong></p>
                    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin-bottom: 15px;">Mapeo de Columnas</h4>
                        ${camposProducto.map(campo => `
                            <div style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                <label style="min-width: 250px; font-weight: 600; color: #333;">${campo.label}</label>
                                <select id="map_${campo.key}" class="form-control" style="flex: 1;" onchange="actualizarMapeo('${campo.key}', this.value)">${opcionesColumnas}</select>
                            </div>
                        `).join('')}
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px;">
                        <h4 style="margin-bottom: 10px;">Vista Previa de Datos</h4>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
                                <thead><tr style="background: #f5f5f5;">${csvHeaders.map(h => `<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">${h}</th>`).join('')}</tr></thead>
                                <tbody>
                                    ${csvData.slice(0, 3).map(row => `<tr>${csvHeaders.map(h => `<td style="padding: 8px; border: 1px solid #ddd;">${row[h] || ''}</td>`).join('')}</tr>`).join('')}
                                    ${csvData.length > 3 ? `<tr><td colspan="${csvHeaders.length}" style="padding: 8px; text-align: center; color: #999; font-style: italic;">... y ${csvData.length - 3} filas más</td></tr>` : ''}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('csvPreviewActualizar').innerHTML = htmlMapeo;
            Object.keys(csvMapping).forEach(key => {
                const select = document.getElementById(`map_${key}`);
                if (select && csvMapping[key]) select.value = csvMapping[key];
            });
            document.getElementById('btnVerVistaPrevia').style.display = 'inline-block';
            document.getElementById('btnActualizarCSV').style.display = 'inline-block';
            document.getElementById('vistaPreviaStock').innerHTML = ''; // Limpiar vista previa anterior
        }

        async function verVistaPreviaStock() {
            if (csvData.length === 0) {
                alert('No hay datos para procesar');
                return;
            }

            const productosImportar = procesarDatosCSV();
            if (productosImportar.length === 0) {
                alert('No se pudo procesar ningún producto. Verifica el formato de los datos.');
                return;
            }

            try {
                const response = await fetch('/api/productos/actualizar-stock-csv', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ productos: productosImportar, vistaPrevia: true })
                });

                if (response.ok) {
                    const data = await response.json();
                    mostrarVistaPreviaStock(data);
                } else {
                    const errorData = await response.json();
                    alert(`Error al generar vista previa: ${errorData.mensaje || 'Error desconocido'}`);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al generar vista previa. Verifica la conexión con el servidor.');
            }
        }

        function mostrarVistaPreviaStock(data) {
            const vistaPrevia = data.vistaPrevia || [];
            const resultados = data.resultados;

            if (vistaPrevia.length === 0) {
                document.getElementById('vistaPreviaStock').innerHTML = `
                    <div style="background: #fff3e0; padding: 20px; border-radius: 10px; border-left: 4px solid #ff9800;">
                        <h3 style="color: #ff6f00;">⚠️ Sin cambios</h3>
                        <p>No se encontraron productos para actualizar o no hay coincidencias de SKU.</p>
                    </div>
                `;
                return;
            }

            let html = `
                <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; border-left: 4px solid #2196f3; margin-top: 20px;">
                    <h3 style="color: #1565c0; margin-bottom: 15px;">👁️ Vista Previa: Antes y Después</h3>
                    <p style="color: #666; margin-bottom: 20px;">
                        Mostrando los primeros ${vistaPrevia.length} productos que serán actualizados.<br>
                        Total de productos a actualizar: <strong>${resultados.actualizados.length}</strong>
                    </p>
            `;

            vistaPrevia.forEach((producto, index) => {
                html += `
                    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #bbdefb;">
                        <h4 style="color: #1976d2; margin-bottom: 10px;">${index + 1}. ${producto.nombre}</h4>
                        <p style="color: #666; margin-bottom: 15px; font-size: 0.9em;">SKU: <strong>${producto.sku}</strong></p>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <h5 style="color: #666; margin-bottom: 10px; font-size: 0.9em; text-transform: uppercase;">⏮️ Antes</h5>
                                <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                                    <thead>
                                        <tr style="background: #f5f5f5;">
                                            <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Talla</th>
                                            <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Stock</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${producto.antes.map(v => `
                                            <tr>
                                                <td style="padding: 8px; border: 1px solid #ddd;">${v.talla}</td>
                                                <td style="padding: 8px; border: 1px solid #ddd;">${v.stock}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>

                            <div>
                                <h5 style="color: #2196f3; margin-bottom: 10px; font-size: 0.9em; text-transform: uppercase;">⏭️ Después</h5>
                                <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                                    <thead>
                                        <tr style="background: #e3f2fd;">
                                            <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Talla</th>
                                            <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Stock</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${producto.despues.map(v => {
                                            const antes = producto.antes.find(a => a.talla === v.talla);
                                            const cambio = antes && antes.stock !== v.stock;
                                            return `
                                                <tr ${cambio ? 'style="background: #fff3e0;"' : ''}>
                                                    <td style="padding: 8px; border: 1px solid #ddd;">${v.talla}</td>
                                                    <td style="padding: 8px; border: 1px solid #ddd; ${cambio ? 'font-weight: bold; color: #ff6f00;' : ''}">${v.stock}</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `</div>`;
            document.getElementById('vistaPreviaStock').innerHTML = html;

            // Scroll suave a la vista previa
            setTimeout(() => {
                document.getElementById('vistaPreviaStock').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
        }

        async function actualizarProductosCSV() {
            if (csvData.length === 0) {
                alert('No hay datos para importar');
                return;
            }

            const productosImportar = procesarDatosCSV();
            if (productosImportar.length === 0) {
                alert('No se pudo procesar ningún producto. Verifica el formato de los datos.');
                return;
            }

            if (!confirm(`Se actualizará SOLO el stock de los productos existentes que coincidan con el SKU.\nNO se añadirán productos nuevos.\n\n¿Deseas continuar?`)) return;

            try {
                const response = await fetch('/api/productos/actualizar-stock-csv', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ productos: productosImportar, vistaPrevia: false })
                });

                if (response.ok) {
                    const data = await response.json();
                    cerrarModalActualizarProductos();
                    cargarProductos();

                    // Mostrar resumen de actualización
                    const resumen = data.resultados;
                    let mensaje = `✅ Actualización completada:\n\n`;
                    mensaje += `✓ ${resumen.actualizados.length} productos actualizados\n`;
                    if (resumen.noEncontrados.length > 0) {
                        mensaje += `⚠ ${resumen.noEncontrados.length} SKUs no encontrados en tu catálogo\n`;
                    }
                    if (resumen.errores.length > 0) {
                        mensaje += `❌ ${resumen.errores.length} errores\n`;
                    }

                    alert(mensaje);
                } else {
                    const errorData = await response.json();
                    alert(`Error al actualizar productos: ${errorData.mensaje || 'Error desconocido'}`);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al actualizar productos. Verifica la conexión con el servidor.');
            }
        }

        // ==================== MODAL AÑADIR PRODUCTOS NUEVOS ====================
        function abrirModalProductosNuevos() {
            document.getElementById('csvPreviewNuevos').innerHTML = '';
            document.getElementById('btnNuevosCSV').style.display = 'none';
            document.getElementById('modalProductosNuevos').classList.add('show');
        }

        function cerrarModalProductosNuevos() {
            document.getElementById('modalProductosNuevos').classList.remove('show');
            csvData = [];
            csvHeaders = [];
            csvMapping = {};
        }

        function procesarCSVNuevos(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim());

                    if (lines.length < 2) {
                        alert('El archivo CSV debe contener al menos una fila de encabezados y una de datos');
                        return;
                    }

                    csvHeaders = parseCSVLine(lines[0]);
                    csvData = [];
                    for (let i = 1; i < lines.length; i++) {
                        const values = parseCSVLine(lines[i]);
                        const row = {};
                        csvHeaders.forEach((header, index) => {
                            row[header] = values[index] || '';
                        });
                        csvData.push(row);
                    }

                    console.log('CSV nuevos procesado:', csvData.length, 'filas');
                    csvMapping = autoMapearColumnas(csvHeaders);
                    mostrarInterfazMapeoNuevos();
                } catch (error) {
                    console.error('Error procesando CSV:', error);
                    alert('Error al procesar el archivo CSV: ' + error.message);
                }
            };

            reader.readAsText(file, 'UTF-8');
        }

        function mostrarInterfazMapeoNuevos() {
            const camposProducto = [
                { key: 'sku', label: 'SKU (Código de Producto) ⭐' },
                { key: 'nombre', label: 'Nombre del Producto' },
                { key: 'precio', label: 'Precio' },
                { key: 'imagen', label: 'Imagen Principal' },
                { key: 'descripcion', label: 'Descripción' },
                { key: 'talla', label: 'Talla Individual (para variantes por fila)' },
                { key: 'stock', label: 'Stock / Inventario' }
            ];

            // Mapeo automático por defecto para Shopify CSV
            const mapeoAutomatico = {
                'sku': 'Variant SKU',
                'nombre': 'Title',
                'precio': 'Variant Price',
                'imagen': 'Image Src',
                'descripcion': 'Body (HTML)',
                'talla': 'Option1 Value',
                'stock': 'Variant Inventory Qty'
            };

            // Aplicar mapeo automático si las columnas existen
            Object.keys(mapeoAutomatico).forEach(key => {
                const columnaCSV = mapeoAutomatico[key];
                if (csvHeaders.includes(columnaCSV)) {
                    csvMapping[key] = columnaCSV;
                }
            });

            // Filtrar columnas excluidas del desplegable
            const headersFiltrados = csvHeaders.filter(h => !columnasExcluidas.includes(h));
            const opcionesColumnas = `<option value="">-- No importar --</option>${headersFiltrados.map(h => `<option value="${h}">${h}</option>`).join('')}`;

            const htmlMapeo = `
                <div style="background: #e8f5e9; padding: 20px; border-radius: 10px; margin-top: 20px; border-left: 4px solid #4caf50;">
                    <h3 style="color: #2e7d32; margin-bottom: 15px;">✨ Configurar Importación de Nuevos</h3>
                    <p style="color: #666; margin-bottom: 20px;">Se detectaron ${csvData.length} filas y ${csvHeaders.length} columnas.<br><strong>Modo: Solo productos nuevos</strong> - Los productos con SKU duplicado serán omitidos.<br><strong style="color: #4caf50;">✓ Mapeo automático aplicado</strong></p>
                    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin-bottom: 15px;">Mapeo de Columnas</h4>
                        ${camposProducto.map(campo => `
                            <div style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                <label style="min-width: 250px; font-weight: 600; color: #333;">${campo.label}</label>
                                <select id="map_${campo.key}" class="form-control" style="flex: 1;" onchange="actualizarMapeo('${campo.key}', this.value)">${opcionesColumnas}</select>
                            </div>
                        `).join('')}
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px;">
                        <h4 style="margin-bottom: 10px;">Vista Previa de Datos</h4>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
                                <thead><tr style="background: #f5f5f5;">${csvHeaders.map(h => `<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">${h}</th>`).join('')}</tr></thead>
                                <tbody>
                                    ${csvData.slice(0, 3).map(row => `<tr>${csvHeaders.map(h => `<td style="padding: 8px; border: 1px solid #ddd;">${row[h] || ''}</td>`).join('')}</tr>`).join('')}
                                    ${csvData.length > 3 ? `<tr><td colspan="${csvHeaders.length}" style="padding: 8px; text-align: center; color: #999; font-style: italic;">... y ${csvData.length - 3} filas más</td></tr>` : ''}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('csvPreviewNuevos').innerHTML = htmlMapeo;
            Object.keys(csvMapping).forEach(key => {
                const select = document.getElementById(`map_${key}`);
                if (select && csvMapping[key]) select.value = csvMapping[key];
            });
            document.getElementById('btnNuevosCSV').style.display = 'inline-block';
        }

        async function añadirProductosNuevosCSV() {
            if (csvData.length === 0) {
                alert('No hay datos para importar');
                return;
            }

            const productosImportar = procesarDatosCSV();
            if (productosImportar.length === 0) {
                alert('No se pudo procesar ningún producto. Verifica el formato de los datos.');
                return;
            }

            if (!confirm(`Se intentarán añadir ${productosImportar.length} productos nuevos.\nLos duplicados serán omitidos.\n¿Deseas continuar?`)) return;

            try {
                const response = await fetch('/api/productos/upload-csv', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ productos: productosImportar, reemplazar: false, soloNuevos: true })
                });

                if (response.ok) {
                    const data = await response.json();
                    cerrarModalProductosNuevos();
                    cargarProductos();
                    mostrarResumenImportacion(data);
                } else {
                    const errorData = await response.json();
                    alert(`Error al importar productos: ${errorData.mensaje || 'Error desconocido'}`);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al importar productos. Verifica la conexión con el servidor.');
            }
        }

        // ==================== FUNCIONES COMPARTIDAS ====================
        function procesarDatosCSV() {
            const productosImportar = [];
            csvData.forEach((row, index) => {
                try {
                    let imagenesArray = [];
                    if (csvMapping.imagenes && row[csvMapping.imagenes]) {
                        imagenesArray = row[csvMapping.imagenes].split(';').map(img => img.trim()).filter(img => img);
                    } else if (csvMapping.imagen && row[csvMapping.imagen]) {
                        imagenesArray = [row[csvMapping.imagen].trim()];
                    }
                    if (imagenesArray.length === 0) imagenesArray = ['https://via.placeholder.com/500x700?text=Sin+Imagen'];

                    // Procesar talla individual (para variantes por fila)
                    let tallaIndividual = null;
                    if (csvMapping.talla && row[csvMapping.talla]) {
                        tallaIndividual = row[csvMapping.talla].toString().trim();
                    }

                    // Procesar tallas múltiples (para expandir en el backend)
                    let tallasArray = null;
                    if (csvMapping.tallas && row[csvMapping.tallas]) {
                        const tallasStr = row[csvMapping.tallas].toString().trim();
                        if (tallasStr) {
                            tallasArray = tallasStr;
                        }
                    }

                    // Procesar stock
                    let stock = null;
                    if (csvMapping.stock && row[csvMapping.stock]) {
                        const stockValue = parseInt(row[csvMapping.stock]);
                        if (!isNaN(stockValue)) {
                            stock = stockValue;
                        }
                    }

                    let precio = 0;
                    if (csvMapping.precio && row[csvMapping.precio]) {
                        precio = parseFloat(row[csvMapping.precio].toString().replace(',', '.'));
                        if (isNaN(precio)) precio = 0;
                    }

                    let nombre = 'Producto sin nombre';
                    if (csvMapping.nombre && row[csvMapping.nombre]) {
                        nombre = row[csvMapping.nombre].toString().trim();
                        if (!nombre) nombre = `Producto ${index + 1}`;
                    } else {
                        nombre = `Producto ${index + 1}`;
                    }

                    let categoria = 'sin-categoria';
                    if (csvMapping.categoria && row[csvMapping.categoria]) {
                        categoria = row[csvMapping.categoria].toString().trim();
                        if (!categoria) categoria = 'sin-categoria';
                    }

                    let descripcion = 'Sin descripción';
                    if (csvMapping.descripcion && row[csvMapping.descripcion]) {
                        descripcion = row[csvMapping.descripcion].toString().trim();
                        if (!descripcion) descripcion = 'Sin descripción';
                    }

                    let sku = null;
                    if (csvMapping.sku && row[csvMapping.sku]) {
                        sku = row[csvMapping.sku].toString().trim();
                    }

                    let nuevo = false;
                    if (csvMapping.nuevo && row[csvMapping.nuevo]) {
                        const nuevoStr = row[csvMapping.nuevo].toString().toLowerCase().trim();
                        nuevo = nuevoStr === 'true' || nuevoStr === '1' || nuevoStr === 'sí' || nuevoStr === 'si' || nuevoStr === 'yes';
                    }

                    const productoData = { sku, nombre, precio, categoria, imagenes: imagenesArray, descripcion, nuevo };

                    // Agregar talla individual si existe
                    if (tallaIndividual) {
                        productoData.talla = tallaIndividual;
                    }

                    // Agregar tallas múltiples si existe
                    if (tallasArray) {
                        productoData.tallas = tallasArray;
                    }

                    // Agregar stock si existe
                    if (stock !== null) {
                        productoData.stock = stock;
                    }

                    productosImportar.push(productoData);
                } catch (error) {
                    console.error(`Error procesando fila ${index + 2}:`, error);
                }
            });
            return productosImportar;
        }

        function mostrarResumenImportacion(data) {
            let mensajeDetallado = `✅ Importación Completada\n\n${data.mensaje}\n\n`;

            if (data.resultados.nuevos.length > 0) {
                mensajeDetallado += `🆕 Productos Nuevos (${data.resultados.nuevos.length}):\n`;
                data.resultados.nuevos.slice(0, 5).forEach(p => {
                    mensajeDetallado += `  • ${p.nombre}${p.sku ? ` (SKU: ${p.sku})` : ''}\n`;
                });
                if (data.resultados.nuevos.length > 5) mensajeDetallado += `  ... y ${data.resultados.nuevos.length - 5} más\n`;
                mensajeDetallado += '\n';
            }

            if (data.resultados.actualizados.length > 0) {
                mensajeDetallado += `🔄 Productos Actualizados (${data.resultados.actualizados.length}):\n`;
                data.resultados.actualizados.slice(0, 5).forEach(p => {
                    mensajeDetallado += `  • ${p.nombre} (SKU: ${p.sku})\n`;
                });
                if (data.resultados.actualizados.length > 5) mensajeDetallado += `  ... y ${data.resultados.actualizados.length - 5} más\n`;
                mensajeDetallado += '\n';
            }

            if (data.resultados.duplicados.length > 0) {
                mensajeDetallado += `⚠️ Productos Omitidos (${data.resultados.duplicados.length}):\n`;
                data.resultados.duplicados.slice(0, 5).forEach(p => {
                    mensajeDetallado += `  • ${p.nombre} (SKU: ${p.sku}) - ${p.accion}\n`;
                });
                if (data.resultados.duplicados.length > 5) mensajeDetallado += `  ... y ${data.resultados.duplicados.length - 5} más\n`;
                mensajeDetallado += '\n';
            }

            if (data.resultados.errores.length > 0) {
                mensajeDetallado += `❌ Errores (${data.resultados.errores.length}):\n`;
                data.resultados.errores.slice(0, 3).forEach(e => {
                    mensajeDetallado += `  • Fila ${e.fila}: ${e.error}\n`;
                });
                if (data.resultados.errores.length > 3) mensajeDetallado += `  ... y ${data.resultados.errores.length - 3} más\n`;
            }

            alert(mensajeDetallado);
        }

        // Gestión de Categorías
        async function cargarCategorias() {
            try {
                const response = await fetch('/api/categorias');
                categoriasData = await response.json();
                renderizarCategorias();
            } catch (error) {
                console.error('Error al cargar categorías:', error);
            }
        }

        function renderizarCategorias() {
            const listaCategorias = document.getElementById('listaCategorias');
            const selectPadre = document.getElementById('nuevaCategoriaPadre');

            if (categoriasData.length === 0) {
                listaCategorias.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">No hay categorías disponibles</div>';
                selectPadre.innerHTML = '<option value="">Categoría Principal (sin padre)</option>';
                return;
            }

            // Actualizar el select de categorías padre
            const categoriasPrincipales = categoriasData.filter(c => !c.parentId);
            selectPadre.innerHTML = '<option value="">Categoría Principal (sin padre)</option>' +
                categoriasPrincipales.map(cat =>
                    `<option value="${cat.id}">↳ Subcategoría de: ${cat.nombre.charAt(0).toUpperCase() + cat.nombre.slice(1)}</option>`
                ).join('');

            // Organizar categorías jerárquicamente
            const categoriasPrincipalesHTML = categoriasPrincipales.map(categoria => {
                const subcategorias = categoriasData.filter(c => c.parentId === categoria.id);

                return `
                    <div style="border: 2px solid #e0e0e0; border-radius: 10px; padding: 15px; background: white;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: ${subcategorias.length > 0 ? '15px' : '0'};">
                            <span style="font-size: 1.2em; color: #667eea;">📁</span>
                            <input type="text" value="${categoria.nombre}" id="cat-${categoria.id}" class="form-control" style="flex: 1;">
                            <button class="btn-small btn-edit" onclick="actualizarCategoria(${categoria.id})">💾</button>
                            <button class="btn-small btn-delete" onclick="eliminarCategoria(${categoria.id})">🗑️</button>
                        </div>
                        ${subcategorias.length > 0 ? `
                            <div style="margin-left: 30px; display: flex; flex-direction: column; gap: 8px;">
                                ${subcategorias.map(sub => `
                                    <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #667eea;">
                                        <span style="color: #999;">└─</span>
                                        <input type="text" value="${sub.nombre}" id="cat-${sub.id}" class="form-control" style="flex: 1; font-size: 0.9em;">
                                        <select id="cat-parent-${sub.id}" class="form-control" style="width: auto;">
                                            <option value="">Sin padre</option>
                                            ${categoriasPrincipales.filter(c => c.id !== sub.id).map(c =>
                                                `<option value="${c.id}" ${c.id === sub.parentId ? 'selected' : ''}>${c.nombre}</option>`
                                            ).join('')}
                                        </select>
                                        <button class="btn-small btn-edit" onclick="actualizarCategoria(${sub.id})">💾</button>
                                        <button class="btn-small btn-delete" onclick="eliminarCategoria(${sub.id})">🗑️</button>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            listaCategorias.innerHTML = categoriasPrincipalesHTML;
        }

        function abrirModalCategorias() {
            cargarCategorias();
            document.getElementById('modalCategorias').classList.add('show');
        }

        function cerrarModalCategorias() {
            document.getElementById('modalCategorias').classList.remove('show');
        }

        async function agregarCategoria() {
            const nombre = document.getElementById('nuevaCategoria').value.trim();
            const parentId = document.getElementById('nuevaCategoriaPadre').value;

            if (!nombre) {
                alert('Por favor ingresa un nombre para la categoría');
                return;
            }

            try {
                const response = await fetch('/api/categorias', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nombre,
                        parentId: parentId || null
                    })
                });

                if (response.ok) {
                    document.getElementById('nuevaCategoria').value = '';
                    document.getElementById('nuevaCategoriaPadre').value = '';
                    cargarCategorias();
                    cargarProductos(); // Recargar productos para actualizar filtros
                    alert(parentId ? 'Subcategoría añadida correctamente' : 'Categoría añadida correctamente');
                } else {
                    const data = await response.json();
                    alert(data.mensaje || 'Error al añadir categoría');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al añadir categoría');
            }
        }

        async function actualizarCategoria(id) {
            const nuevoNombre = document.getElementById(`cat-${id}`).value.trim();
            const parentSelect = document.getElementById(`cat-parent-${id}`);
            const parentId = parentSelect ? parentSelect.value : null;

            if (!nuevoNombre) {
                alert('El nombre de la categoría no puede estar vacío');
                return;
            }

            try {
                const response = await fetch(`/api/categorias/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nombre: nuevoNombre,
                        parentId: parentId || null
                    })
                });

                if (response.ok) {
                    cargarCategorias();
                    cargarProductos();
                    alert('Categoría actualizada correctamente');
                } else {
                    const data = await response.json();
                    alert(data.mensaje || 'Error al actualizar categoría');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al actualizar categoría');
            }
        }

        async function eliminarCategoria(id) {
            if (!confirm('¿Estás seguro de que quieres eliminar esta categoría?')) return;

            try {
                const response = await fetch(`/api/categorias/${id}`, { method: 'DELETE' });

                if (response.ok) {
                    cargarCategorias();
                    cargarProductos();
                    alert('Categoría eliminada correctamente');
                } else {
                    const data = await response.json();
                    alert(data.mensaje || 'Error al eliminar categoría');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al eliminar categoría');
            }
        }

        // Editar producto
        async function editarProducto(id) {
            const producto = productosData.find(p => p.id === id);
            if (!producto) return;

            // Cargar categorías en el select
            await cargarCategoriasEnSelect();

            // Cargar imágenes del producto (con soporte para variantes)
            imagenesProducto = [];

            // Prioridad 1: Recolectar todas las imágenes de todas las variantes
            if (producto.variantes && Array.isArray(producto.variantes) && producto.variantes.length > 0) {
                producto.variantes.forEach(variante => {
                    if (variante.imagenes && Array.isArray(variante.imagenes)) {
                        imagenesProducto = [...imagenesProducto, ...variante.imagenes];
                    }
                });
            }

            // Prioridad 2: Imagenes directas en el producto (formato antiguo)
            if (imagenesProducto.length === 0 && producto.imagenes && Array.isArray(producto.imagenes)) {
                imagenesProducto = [...producto.imagenes];
            }

            // Prioridad 3: Imagen única (muy antiguo)
            if (imagenesProducto.length === 0 && producto.imagen) {
                imagenesProducto = [producto.imagen];
            }

            // Eliminar duplicados
            imagenesProducto = [...new Set(imagenesProducto)];

            renderizarImagenes();

            document.getElementById('modalProductoTitulo').textContent = 'Editar Producto';
            document.getElementById('productoId').value = producto.id;
            document.getElementById('productoNombre').value = producto.nombre;
            document.getElementById('productoPrecio').value = producto.precio;
            document.getElementById('productoCategoria').value = producto.categoria;
            document.getElementById('productoDescripcion').value = producto.descripcion;

            // Cargar tallas (con soporte para variantes)
            let tallasStr = '';
            if (producto.variantes && Array.isArray(producto.variantes) && producto.variantes.length > 0) {
                tallasStr = producto.variantes.map(v => v.talla).join(', ');
            } else if (producto.tallas && Array.isArray(producto.tallas)) {
                tallasStr = producto.tallas.join(', ');
            }
            document.getElementById('productoTallas').value = tallasStr;

            document.getElementById('productoNuevo').checked = producto.nuevo || false;
            document.getElementById('productoDestacado').checked = producto.destacado || false;
            document.getElementById('modalProducto').classList.add('show');
        }

        // Guardar producto
        async function guardarProducto(event) {
            event.preventDefault();

            // Validar que haya al menos una imagen
            if (imagenesProducto.length === 0) {
                alert('Por favor añade al menos una imagen al producto');
                return;
            }

            const id = document.getElementById('productoId').value;
            const tallasInput = document.getElementById('productoTallas').value;
            const tallas = tallasInput.split(',').map(t => t.trim());

            const productoData = {
                nombre: document.getElementById('productoNombre').value,
                precio: parseFloat(document.getElementById('productoPrecio').value),
                categoria: document.getElementById('productoCategoria').value,
                imagenes: imagenesProducto,
                descripcion: document.getElementById('productoDescripcion').value,
                tallas: tallas,
                nuevo: document.getElementById('productoNuevo').checked,
                destacado: document.getElementById('productoDestacado').checked
            };

            try {
                const url = id ? `/api/productos/${id}` : '/api/productos';
                const method = id ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productoData)
                });

                if (response.ok) {
                    cerrarModalProducto();
                    cargarProductos();
                    alert(id ? 'Producto actualizado correctamente' : 'Producto creado correctamente');
                } else {
                    alert('Error al guardar el producto');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar el producto');
            }
        }

        // Eliminar producto
        async function eliminarProducto(id) {
            if (!confirm('¿Estás seguro de que quieres eliminar este producto?')) return;

            try {
                const response = await fetch(`/api/productos/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    cargarProductos();
                    alert('Producto eliminado correctamente');
                } else {
                    alert('Error al eliminar el producto');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al eliminar el producto');
            }
        }

        // ==================== FUNCIONES DE SELECCIÓN MASIVA ====================

        function seleccionarTodos(checked) {
            const checkboxes = document.querySelectorAll('.producto-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = checked;
            });
            actualizarContadorSeleccionados();
        }

        function actualizarContadorSeleccionados() {
            const checkboxes = document.querySelectorAll('.producto-checkbox:checked');
            const contador = checkboxes.length;

            document.getElementById('contadorSeleccionados').textContent = contador;

            // Mostrar/ocultar botón de eliminar
            const btnEliminar = document.getElementById('btnEliminarSeleccionados');
            if (contador > 0) {
                btnEliminar.style.display = 'inline-block';
            } else {
                btnEliminar.style.display = 'none';
            }

            // Actualizar estado del checkbox "Seleccionar todos"
            const totalCheckboxes = document.querySelectorAll('.producto-checkbox').length;
            const selectAll = document.getElementById('selectAllProductos');
            if (selectAll) {
                selectAll.checked = contador === totalCheckboxes && totalCheckboxes > 0;
            }
        }

        async function eliminarProductosSeleccionados() {
            const checkboxes = document.querySelectorAll('.producto-checkbox:checked');
            const ids = Array.from(checkboxes).map(cb => parseInt(cb.dataset.productoId));

            if (ids.length === 0) {
                alert('Por favor selecciona al menos un producto para eliminar');
                return;
            }

            const confirmacion = confirm(`¿Estás seguro de que quieres eliminar ${ids.length} producto(s) seleccionado(s)?\n\nEsta acción no se puede deshacer.`);
            if (!confirmacion) return;

            try {
                const response = await fetch('/api/productos/eliminar-masivo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ ids })
                });

                const data = await response.json();

                if (response.ok) {
                    alert(`✅ ${data.eliminados} producto(s) eliminado(s) correctamente`);
                    document.getElementById('selectAllProductos').checked = false;
                    cargarProductos();
                } else {
                    alert(data.mensaje || 'Error al eliminar los productos');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al eliminar los productos. Verifica la conexión con el servidor.');
            }
        }

        // Procesar CSV
        function procesarCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim());

                    if (lines.length < 2) {
                        alert('El archivo CSV debe contener al menos una fila de encabezados y una de datos');
                        return;
                    }

                    // Parsear encabezados con soporte para comillas
                    csvHeaders = parseCSVLine(lines[0]);

                    // Parsear todas las filas como objetos
                    csvData = [];
                    for (let i = 1; i < lines.length; i++) {
                        const values = parseCSVLine(lines[i]);
                        const row = {};
                        csvHeaders.forEach((header, index) => {
                            row[header] = values[index] || '';
                        });
                        csvData.push(row);
                    }

                    console.log('CSV procesado:', csvData.length, 'filas,', csvHeaders.length, 'columnas');
                    console.log('Headers:', csvHeaders);

                    // Inicializar mapeo automático inteligente
                    csvMapping = autoMapearColumnas(csvHeaders);

                    // Mostrar interfaz de mapeo
                    mostrarInterfazMapeo();
                } catch (error) {
                    console.error('Error procesando CSV:', error);
                    alert('Error al procesar el archivo CSV: ' + error.message);
                }
            };

            reader.readAsText(file, 'UTF-8');
        }

        // Función auxiliar para parsear una línea CSV correctamente (maneja comillas)
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];

                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        // Comillas dobles dentro de un campo entrecomillado
                        current += '"';
                        i++; // Saltar la siguiente comilla
                    } else {
                        // Toggle del estado de comillas
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    // Coma fuera de comillas = separador de campo
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }

            // Agregar el último campo
            result.push(current.trim());

            return result;
        }

        // Función para mapear automáticamente columnas basándose en nombres comunes
        function autoMapearColumnas(headers) {
            const mapping = {
                sku: '',
                nombre: '',
                precio: '',
                categoria: '',
                imagen: '',
                imagenes: '',
                descripcion: '',
                tallas: '',
                talla: '',
                stock: '',
                nuevo: ''
            };

            headers.forEach(header => {
                const headerLower = header.toLowerCase();

                // Mapeo inteligente basado en palabras clave
                if (headerLower === 'sku' || headerLower.includes('codigo') || headerLower.includes('code')) {
                    mapping.sku = header;
                } else if (headerLower.includes('nombre') || headerLower.includes('name') || headerLower.includes('producto')) {
                    mapping.nombre = header;
                } else if (headerLower.includes('precio') || headerLower.includes('price')) {
                    mapping.precio = header;
                } else if (headerLower.includes('stock') || headerLower.includes('inventory')) {
                    mapping.stock = header;
                } else if (headerLower.includes('categoria') || headerLower.includes('category')) {
                    mapping.categoria = header;
                } else if (headerLower.includes('imagen') || headerLower.includes('image') || headerLower.includes('foto')) {
                    if (headerLower.includes('imagenes') || headerLower.includes('images')) {
                        mapping.imagenes = header;
                    } else if (!mapping.imagen) {
                        mapping.imagen = header;
                    }
                } else if (headerLower.includes('descripcion') || headerLower.includes('description') || headerLower.includes('desc')) {
                    mapping.descripcion = header;
                } else if (headerLower.includes('tallas') || headerLower.includes('sizes')) {
                    mapping.tallas = header;
                } else if (headerLower === 'talla' || headerLower === 'size' || headerLower === 'option1 value') {
                    mapping.talla = header;
                } else if (headerLower === 'variant inventory qty' || headerLower.includes('quantity')) {
                    mapping.stock = header;
                } else if (headerLower.includes('nuevo') || headerLower.includes('new')) {
                    mapping.nuevo = header;
                }
            });

            return mapping;
        }

        // Mostrar interfaz de mapeo de columnas
        function mostrarInterfazMapeo() {
            const camposProducto = [
                { key: 'sku', label: 'SKU (Código de Producto) ⭐', required: false },
                { key: 'nombre', label: 'Nombre del Producto', required: false },
                { key: 'precio', label: 'Precio', required: false },
                { key: 'categoria', label: 'Categoría', required: false },
                { key: 'imagen', label: 'Imagen Principal', required: false },
                { key: 'imagenes', label: 'Imágenes Múltiples (separadas por ;)', required: false },
                { key: 'descripcion', label: 'Descripción', required: false },
                { key: 'tallas', label: 'Tallas Múltiples (separadas por ;)', required: false },
                { key: 'talla', label: 'Talla Individual (para variantes por fila)', required: false },
                { key: 'stock', label: 'Stock / Inventario', required: false },
                { key: 'nuevo', label: 'Producto Nuevo (true/false)', required: false }
            ];

            // Filtrar columnas excluidas del desplegable
            const headersFiltrados = csvHeaders.filter(h => !columnasExcluidas.includes(h));
            const opcionesColumnas = `
                <option value="">-- No importar --</option>
                ${headersFiltrados.map(h => `<option value="${h}">${h}</option>`).join('')}
            `;

            const htmlMapeo = `
                <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin-top: 20px;">
                    <h3 style="color: #1976d2; margin-bottom: 15px;">📊 Configurar Importación</h3>
                    <p style="color: #666; margin-bottom: 20px;">
                        Se detectaron ${csvData.length} filas y ${csvHeaders.length} columnas.
                        Mapea las columnas del CSV a los campos del producto:
                    </p>

                    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ff9800;">
                        <h4 style="margin-bottom: 15px; color: #ff9800;">⚙️ Opciones de Importación</h4>
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px; background: #fff3e0; border-radius: 6px;">
                                <input
                                    type="checkbox"
                                    id="csvReemplazar"
                                    onchange="csvReemplazar = this.checked; actualizarOpcionesCSV();"
                                    style="width: 20px; height: 20px; cursor: pointer;"
                                >
                                <div>
                                    <strong style="color: #e65100;">🔄 Reemplazar y Modificar Datos</strong>
                                    <div style="font-size: 0.85em; color: #666; margin-top: 3px;">
                                        Si un producto con el mismo SKU existe, actualizar sus datos con los del CSV
                                    </div>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px; background: #e8f5e9; border-radius: 6px;">
                                <input
                                    type="checkbox"
                                    id="csvSoloNuevos"
                                    onchange="csvSoloNuevos = this.checked; actualizarOpcionesCSV();"
                                    style="width: 20px; height: 20px; cursor: pointer;"
                                >
                                <div>
                                    <strong style="color: #2e7d32;">✨ Solo Productos Nuevos</strong>
                                    <div style="font-size: 0.85em; color: #666; margin-top: 3px;">
                                        Solo importar productos que no existan (basándose en SKU). Omite duplicados.
                                    </div>
                                </div>
                            </label>
                            <div id="advertenciaOpciones" style="display: none; padding: 10px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px; font-size: 0.9em; color: #856404;">
                                ⚠️ No puedes activar ambas opciones a la vez. Elige una o ninguna.
                            </div>
                        </div>
                    </div>

                    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin-bottom: 15px;">Mapeo de Columnas</h4>
                        ${camposProducto.map(campo => `
                            <div style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                <label style="min-width: 250px; font-weight: 600; color: #333;">
                                    ${campo.label}
                                </label>
                                <select
                                    id="map_${campo.key}"
                                    class="form-control"
                                    style="flex: 1;"
                                    onchange="actualizarMapeo('${campo.key}', this.value)"
                                >
                                    ${opcionesColumnas}
                                </select>
                            </div>
                        `).join('')}
                    </div>

                    <div style="background: white; padding: 15px; border-radius: 8px;">
                        <h4 style="margin-bottom: 10px;">Vista Previa de Datos</h4>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
                                <thead>
                                    <tr style="background: #f5f5f5;">
                                        ${csvHeaders.map(h => `<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">${h}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${csvData.slice(0, 3).map(row => `
                                        <tr>
                                            ${csvHeaders.map(h => `<td style="padding: 8px; border: 1px solid #ddd;">${row[h] || ''}</td>`).join('')}
                                        </tr>
                                    `).join('')}
                                    ${csvData.length > 3 ? `
                                        <tr>
                                            <td colspan="${csvHeaders.length}" style="padding: 8px; text-align: center; color: #999; font-style: italic;">
                                                ... y ${csvData.length - 3} filas más
                                            </td>
                                        </tr>
                                    ` : ''}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('csvPreview').innerHTML = htmlMapeo;

            // Establecer valores automáticos del mapeo
            Object.keys(csvMapping).forEach(key => {
                const select = document.getElementById(`map_${key}`);
                if (select && csvMapping[key]) {
                    select.value = csvMapping[key];
                }
            });

            document.getElementById('btnSubirCSV').style.display = 'inline-block';
        }

        // Actualizar mapeo cuando el usuario cambia una selección
        function actualizarMapeo(campo, columna) {
            csvMapping[campo] = columna;
        }

        // Actualizar opciones de CSV (hacer mutuamente exclusivas)
        function actualizarOpcionesCSV() {
            const reemplazarCheck = document.getElementById('csvReemplazar');
            const soloNuevosCheck = document.getElementById('csvSoloNuevos');
            const advertencia = document.getElementById('advertenciaOpciones');

            if (csvReemplazar && csvSoloNuevos) {
                // No pueden estar ambas activas
                if (csvReemplazar) {
                    csvSoloNuevos = false;
                    if (soloNuevosCheck) soloNuevosCheck.checked = false;
                }
                advertencia.style.display = 'block';
                setTimeout(() => {
                    advertencia.style.display = 'none';
                }, 3000);
            } else if (csvSoloNuevos && csvReemplazar) {
                csvReemplazar = false;
                if (reemplazarCheck) reemplazarCheck.checked = false;
                advertencia.style.display = 'block';
                setTimeout(() => {
                    advertencia.style.display = 'none';
                }, 3000);
            }
        }

        // Subir CSV
        async function subirCSV() {
            if (csvData.length === 0) {
                alert('No hay datos para importar');
                return;
            }

            // Convertir los datos del CSV usando el mapeo (sin validaciones obligatorias)
            const productosImportar = [];
            let errores = 0;
            let advertencias = 0;

            csvData.forEach((row, index) => {
                try {
                    // Obtener imágenes
                    let imagenesArray = [];
                    if (csvMapping.imagenes && row[csvMapping.imagenes]) {
                        // Si hay múltiples imágenes separadas por punto y coma
                        imagenesArray = row[csvMapping.imagenes].split(';').map(img => img.trim()).filter(img => img);
                    } else if (csvMapping.imagen && row[csvMapping.imagen]) {
                        // Si solo hay una imagen
                        imagenesArray = [row[csvMapping.imagen].trim()];
                    }

                    // Si no hay imágenes, usar imagen por defecto
                    if (imagenesArray.length === 0) {
                        imagenesArray = ['https://via.placeholder.com/500x700?text=Sin+Imagen'];
                        advertencias++;
                    }

                    // Obtener tallas
                    let tallasArray = [];
                    if (csvMapping.tallas && row[csvMapping.tallas]) {
                        tallasArray = row[csvMapping.tallas].split(';').map(t => t.trim()).filter(t => t);
                    }

                    // Si no hay tallas, usar talla única por defecto
                    if (tallasArray.length === 0) {
                        tallasArray = ['Único'];
                    }

                    // Obtener precio
                    let precio = 0;
                    if (csvMapping.precio && row[csvMapping.precio]) {
                        const precioStr = row[csvMapping.precio].toString().replace(',', '.');
                        precio = parseFloat(precioStr);

                        if (isNaN(precio)) {
                            console.warn(`Fila ${index + 2}: Precio inválido "${row[csvMapping.precio]}", usando 0`);
                            precio = 0;
                            advertencias++;
                        }
                    }

                    // Obtener nombre
                    let nombre = 'Producto sin nombre';
                    if (csvMapping.nombre && row[csvMapping.nombre]) {
                        nombre = row[csvMapping.nombre].toString().trim();
                        if (!nombre) {
                            nombre = `Producto ${index + 1}`;
                            advertencias++;
                        }
                    } else {
                        nombre = `Producto ${index + 1}`;
                        advertencias++;
                    }

                    // Obtener categoría
                    let categoria = 'sin-categoria';
                    if (csvMapping.categoria && row[csvMapping.categoria]) {
                        categoria = row[csvMapping.categoria].toString().trim();
                        if (!categoria) {
                            categoria = 'sin-categoria';
                            advertencias++;
                        }
                    }

                    // Obtener descripción
                    let descripcion = 'Sin descripción';
                    if (csvMapping.descripcion && row[csvMapping.descripcion]) {
                        descripcion = row[csvMapping.descripcion].toString().trim();
                        if (!descripcion) {
                            descripcion = 'Sin descripción';
                            advertencias++;
                        }
                    }

                    // Obtener SKU
                    let sku = null;
                    if (csvMapping.sku && row[csvMapping.sku]) {
                        sku = row[csvMapping.sku].toString().trim();
                    }

                    // Obtener nuevo (boolean)
                    let nuevo = false;
                    if (csvMapping.nuevo && row[csvMapping.nuevo]) {
                        const nuevoStr = row[csvMapping.nuevo].toString().toLowerCase().trim();
                        nuevo = nuevoStr === 'true' || nuevoStr === '1' || nuevoStr === 'sí' || nuevoStr === 'si' || nuevoStr === 'yes';
                    }

                    const producto = {
                        sku: sku,
                        nombre: nombre,
                        precio: precio,
                        categoria: categoria,
                        imagenes: imagenesArray,
                        descripcion: descripcion,
                        tallas: tallasArray,
                        nuevo: nuevo
                    };

                    productosImportar.push(producto);
                } catch (error) {
                    console.error(`Error procesando fila ${index + 2}:`, error);
                    errores++;
                }
            });

            if (productosImportar.length === 0) {
                alert('No se pudo procesar ningún producto. Verifica el formato de los datos.');
                return;
            }

            // Mostrar resumen antes de importar
            let mensaje = `Se procesarán ${productosImportar.length} productos`;
            if (advertencias > 0) {
                mensaje += `\n\n⚠️ ${advertencias} campo(s) usarán valores por defecto (sin datos en CSV)`;
            }
            if (errores > 0) {
                mensaje += `\n❌ ${errores} fila(s) no pudieron procesarse`;
            }
            mensaje += '\n\n¿Deseas continuar con la importación?';

            if (!confirm(mensaje)) {
                return;
            }

            try {
                const response = await fetch('/api/productos/upload-csv', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        productos: productosImportar,
                        reemplazar: csvReemplazar,
                        soloNuevos: csvSoloNuevos
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    cerrarModalCSV();
                    cargarProductos();

                    // Mostrar resumen detallado
                    let mensajeDetallado = `✅ Importación Completada\n\n${data.mensaje}\n\n`;

                    if (data.resultados.nuevos.length > 0) {
                        mensajeDetallado += `🆕 Productos Nuevos (${data.resultados.nuevos.length}):\n`;
                        data.resultados.nuevos.slice(0, 5).forEach(p => {
                            mensajeDetallado += `  • ${p.nombre}${p.sku ? ` (SKU: ${p.sku})` : ''}\n`;
                        });
                        if (data.resultados.nuevos.length > 5) {
                            mensajeDetallado += `  ... y ${data.resultados.nuevos.length - 5} más\n`;
                        }
                        mensajeDetallado += '\n';
                    }

                    if (data.resultados.actualizados.length > 0) {
                        mensajeDetallado += `🔄 Productos Actualizados (${data.resultados.actualizados.length}):\n`;
                        data.resultados.actualizados.slice(0, 5).forEach(p => {
                            mensajeDetallado += `  • ${p.nombre} (SKU: ${p.sku})\n`;
                        });
                        if (data.resultados.actualizados.length > 5) {
                            mensajeDetallado += `  ... y ${data.resultados.actualizados.length - 5} más\n`;
                        }
                        mensajeDetallado += '\n';
                    }

                    if (data.resultados.duplicados.length > 0) {
                        mensajeDetallado += `⚠️ Productos Omitidos (${data.resultados.duplicados.length}):\n`;
                        data.resultados.duplicados.slice(0, 5).forEach(p => {
                            mensajeDetallado += `  • ${p.nombre} (SKU: ${p.sku}) - ${p.accion}\n`;
                        });
                        if (data.resultados.duplicados.length > 5) {
                            mensajeDetallado += `  ... y ${data.resultados.duplicados.length - 5} más\n`;
                        }
                        mensajeDetallado += '\n';
                    }

                    if (data.resultados.errores.length > 0) {
                        mensajeDetallado += `❌ Errores (${data.resultados.errores.length}):\n`;
                        data.resultados.errores.slice(0, 3).forEach(e => {
                            mensajeDetallado += `  • Fila ${e.fila}: ${e.error}\n`;
                        });
                        if (data.resultados.errores.length > 3) {
                            mensajeDetallado += `  ... y ${data.resultados.errores.length - 3} más\n`;
                        }
                    }

                    alert(mensajeDetallado);
                } else {
                    const errorData = await response.json();
                    alert(`Error al importar productos: ${errorData.mensaje || 'Error desconocido'}`);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al importar productos. Verifica la conexión con el servidor.');
            }
        }

        // ==================== GESTIÓN DE DESCUENTOS ====================

        async function cargarDescuentos() {
            try {
                const response = await fetch('/api/descuentos', {
                    credentials: 'include'
                });
                descuentosData = await response.json();
                renderizarDescuentos();
            } catch (error) {
                console.error('Error al cargar descuentos:', error);
                document.getElementById('descuentos-lista').innerHTML =
                    '<div class="loading">Error al cargar descuentos</div>';
            }
        }

        function renderizarDescuentos() {
            const listaDescuentos = document.getElementById('descuentos-lista');

            if (descuentosData.length === 0) {
                listaDescuentos.innerHTML = '<div class="no-pedidos">No hay descuentos creados todavía</div>';
                return;
            }

            listaDescuentos.innerHTML = descuentosData
                .sort((a, b) => new Date(b.creadoEn) - new Date(a.creadoEn))
                .map(descuento => {
                    const fechaInicio = descuento.fechaInicio ? new Date(descuento.fechaInicio).toLocaleDateString('es-ES') : 'Siempre';
                    const fechaFin = descuento.fechaFin ? new Date(descuento.fechaFin).toLocaleDateString('es-ES') : 'Siempre';

                    let aplicacion = 'Todos los productos';
                    if (descuento.tipo === 'categoria') {
                        aplicacion = `Categoría: ${descuento.aplicaA}`;
                    } else if (descuento.tipo === 'producto') {
                        const prod = productosData.find(p => p.id === descuento.aplicaA);
                        aplicacion = prod ? `Producto: ${prod.nombre}` : `Producto ID: ${descuento.aplicaA}`;
                    } else if (descuento.tipo === 'pedido') {
                        aplicacion = `Pedidos superiores a €${descuento.montoMinimo?.toFixed(2) || 0}`;
                    }

                    return `
                        <div class="pedido-card" style="border-left-color: ${descuento.activo ? '#4caf50' : '#999'};">
                            <div class="pedido-header">
                                <span class="pedido-id">${descuento.nombre}</span>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    ${descuento.activo ? `
                                    <span style="background: #e3f2fd; color: #1976d2; padding: 5px 12px; border-radius: 15px; font-size: 0.85em; font-weight: 600;">
                                        📊 ${descuento.vecesUsado || 0} ${(descuento.vecesUsado || 0) === 1 ? 'uso' : 'usos'}
                                    </span>
                                    ` : ''}
                                    <span class="estado ${descuento.activo ? 'completado' : 'pendiente'}">
                                        ${descuento.activo ? 'Activo' : 'Inactivo'}
                                    </span>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 15px 0;">
                                ${descuento.tipo === 'pedido' ? `
                                    <div>
                                        <strong>Beneficio:</strong> ${descuento.tipoBeneficio === 'envio_gratis' ? 'Envío Gratuito' : (descuento.tipoBeneficioGlobal === 'cantidad' ? `Descuento €${descuento.cantidad?.toFixed(2) || 0}` : `Descuento ${descuento.porcentaje}%`)}
                                    </div>
                                ` : `
                                    <div>
                                        <strong>Descuento:</strong> ${descuento.tipoBeneficioGlobal === 'cantidad' ? `€${descuento.cantidad?.toFixed(2) || 0}` : `${descuento.porcentaje}%`}
                                    </div>
                                `}
                                <div>
                                    <strong>Aplica a:</strong> ${aplicacion}
                                </div>
                                <div>
                                    <strong>Inicio:</strong> ${fechaInicio}
                                </div>
                                <div>
                                    <strong>Fin:</strong> ${fechaFin}
                                </div>
                                ${descuento.codigo ? `
                                <div>
                                    <strong>Código:</strong> <span style="background: #e8eaf6; padding: 4px 8px; border-radius: 4px; font-family: monospace;">${descuento.codigo}</span>
                                </div>
                                ` : ''}
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 15px;">
                                <button class="btn-small btn-edit" onclick="editarDescuento(${descuento.id})">✏️ Editar</button>
                                <button class="btn-small" style="background: ${descuento.activo ? '#ff9800' : '#4caf50'}; color: white;"
                                    onclick="toggleDescuentoActivo(${descuento.id})">
                                    ${descuento.activo ? '⏸️ Desactivar' : '▶️ Activar'}
                                </button>
                                <button class="btn-small btn-delete" onclick="eliminarDescuento(${descuento.id})">🗑️ Eliminar</button>
                            </div>
                        </div>
                    `;
                }).join('');
        }

        async function abrirModalDescuento() {
            document.getElementById('modalDescuentoTitulo').textContent = 'Nuevo Descuento';
            document.getElementById('formDescuento').reset();
            document.getElementById('descuentoId').value = '';
            document.getElementById('descuentoActivo').checked = true;

            // Ocultar el campo de aplicación por defecto
            document.getElementById('descuentoAplicaAContainer').style.display = 'none';

            document.getElementById('modalDescuento').classList.add('show');
        }

        function cerrarModalDescuento() {
            document.getElementById('modalDescuento').classList.remove('show');
        }

        async function actualizarCamposDescuento() {
            const tipo = document.getElementById('descuentoTipo').value;
            const tipoBeneficioGlobal = document.getElementById('descuentoTipoBeneficioGlobal').value;
            const container = document.getElementById('descuentoAplicaAContainer');
            const label = document.getElementById('descuentoAplicaALabel');
            const select = document.getElementById('descuentoAplicaA');
            const montoMinimoContainer = document.getElementById('descuentoMontoMinimoContainer');
            const tipoBeneficioContainer = document.getElementById('descuentoTipoBeneficioContainer');
            const montoMinimoInput = document.getElementById('descuentoMontoMinimo');
            const porcentajeContainer = document.getElementById('descuentoPorcentajeContainer');
            const cantidadContainer = document.getElementById('descuentoCantidadContainer');

            // Mostrar/ocultar campos según el tipo de beneficio global
            if (tipoBeneficioGlobal === 'porcentaje') {
                porcentajeContainer.style.display = 'block';
                cantidadContainer.style.display = 'none';
                document.getElementById('descuentoPorcentaje').required = true;
                document.getElementById('descuentoCantidad').required = false;
            } else if (tipoBeneficioGlobal === 'cantidad') {
                porcentajeContainer.style.display = 'none';
                cantidadContainer.style.display = 'block';
                document.getElementById('descuentoPorcentaje').required = false;
                document.getElementById('descuentoCantidad').required = true;
            }

            if (tipo === 'general') {
                container.style.display = 'none';
                select.required = false;
                montoMinimoContainer.style.display = 'none';
                tipoBeneficioContainer.style.display = 'none';
                montoMinimoInput.required = false;
            } else if (tipo === 'categoria') {
                container.style.display = 'block';
                label.textContent = 'Categoría:';
                select.required = true;
                montoMinimoContainer.style.display = 'none';
                tipoBeneficioContainer.style.display = 'none';
                montoMinimoInput.required = false;

                // Cargar categorías
                try {
                    const response = await fetch('/api/categorias', {
                        credentials: 'include'
                    });
                    const categorias = await response.json();
                    select.innerHTML = categorias.map(cat =>
                        `<option value="${cat.nombre}">${cat.nombre.charAt(0).toUpperCase() + cat.nombre.slice(1)}</option>`
                    ).join('');
                } catch (error) {
                    console.error('Error al cargar categorías:', error);
                }
            } else if (tipo === 'producto') {
                container.style.display = 'block';
                label.textContent = 'Producto:';
                select.required = true;
                montoMinimoContainer.style.display = 'none';
                tipoBeneficioContainer.style.display = 'none';
                montoMinimoInput.required = false;

                // Cargar productos
                select.innerHTML = productosData.map(prod =>
                    `<option value="${prod.id}">${prod.nombre}</option>`
                ).join('');
            } else if (tipo === 'pedido') {
                container.style.display = 'none';
                select.required = false;
                montoMinimoContainer.style.display = 'block';
                tipoBeneficioContainer.style.display = 'block';
                montoMinimoInput.required = true;

                // Controlar la visibilidad del campo de porcentaje/cantidad según el tipo de beneficio
                const tipoBeneficio = document.getElementById('descuentoTipoBeneficio').value;
                if (tipoBeneficio === 'envio_gratis') {
                    if (tipoBeneficioGlobal === 'porcentaje') {
                        porcentajeContainer.style.display = 'none';
                        document.getElementById('descuentoPorcentaje').required = false;
                    } else {
                        cantidadContainer.style.display = 'none';
                        document.getElementById('descuentoCantidad').required = false;
                    }
                }
            }
        }

        async function guardarDescuento(event) {
            event.preventDefault();

            const id = document.getElementById('descuentoId').value;
            const tipo = document.getElementById('descuentoTipo').value;

            let aplicaA = null;
            if (tipo === 'categoria') {
                aplicaA = document.getElementById('descuentoAplicaA').value;
            } else if (tipo === 'producto') {
                aplicaA = parseInt(document.getElementById('descuentoAplicaA').value);
            }

            const tipoBeneficioGlobal = document.getElementById('descuentoTipoBeneficioGlobal').value;

            const descuentoData = {
                nombre: document.getElementById('descuentoNombre').value,
                tipoBeneficioGlobal: tipoBeneficioGlobal,
                porcentaje: tipoBeneficioGlobal === 'porcentaje'
                    ? (tipo === 'pedido' && document.getElementById('descuentoTipoBeneficio').value === 'envio_gratis'
                        ? 0
                        : parseFloat(document.getElementById('descuentoPorcentaje').value))
                    : 0,
                cantidad: tipoBeneficioGlobal === 'cantidad'
                    ? parseFloat(document.getElementById('descuentoCantidad').value)
                    : 0,
                tipo: tipo,
                aplicaA: aplicaA,
                fechaInicio: document.getElementById('descuentoFechaInicio').value || null,
                fechaFin: document.getElementById('descuentoFechaFin').value || null,
                codigo: document.getElementById('descuentoCodigo').value || null,
                activo: document.getElementById('descuentoActivo').checked
            };

            // Añadir campos específicos para descuentos de tipo "pedido"
            if (tipo === 'pedido') {
                descuentoData.montoMinimo = parseFloat(document.getElementById('descuentoMontoMinimo').value);
                descuentoData.tipoBeneficio = document.getElementById('descuentoTipoBeneficio').value;
            }

            try {
                const url = id ? `/api/descuentos/${id}` : '/api/descuentos';
                const method = id ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(descuentoData)
                });

                if (response.ok) {
                    cerrarModalDescuento();
                    cargarDescuentos();
                    alert(id ? 'Descuento actualizado correctamente' : 'Descuento creado correctamente');
                } else {
                    const data = await response.json();
                    alert(data.mensaje || 'Error al guardar el descuento');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar el descuento');
            }
        }

        async function editarDescuento(id) {
            const descuento = descuentosData.find(d => d.id === id);
            if (!descuento) return;

            document.getElementById('modalDescuentoTitulo').textContent = 'Editar Descuento';
            document.getElementById('descuentoId').value = descuento.id;
            document.getElementById('descuentoNombre').value = descuento.nombre;

            // Establecer tipo de beneficio global
            const tipoBeneficioGlobal = descuento.tipoBeneficioGlobal || (descuento.cantidad > 0 ? 'cantidad' : 'porcentaje');
            document.getElementById('descuentoTipoBeneficioGlobal').value = tipoBeneficioGlobal;

            document.getElementById('descuentoPorcentaje').value = descuento.porcentaje || 0;
            document.getElementById('descuentoCantidad').value = descuento.cantidad || 0;
            document.getElementById('descuentoTipo').value = descuento.tipo;
            document.getElementById('descuentoCodigo').value = descuento.codigo || '';
            document.getElementById('descuentoActivo').checked = descuento.activo;

            // Cargar campos específicos de descuentos de tipo "pedido"
            if (descuento.tipo === 'pedido') {
                document.getElementById('descuentoMontoMinimo').value = descuento.montoMinimo || '';
                document.getElementById('descuentoTipoBeneficio').value = descuento.tipoBeneficio || 'envio_gratis';
            }

            // Formatear fechas para datetime-local
            if (descuento.fechaInicio) {
                const fechaInicio = new Date(descuento.fechaInicio);
                document.getElementById('descuentoFechaInicio').value = fechaInicio.toISOString().slice(0, 16);
            }
            if (descuento.fechaFin) {
                const fechaFin = new Date(descuento.fechaFin);
                document.getElementById('descuentoFechaFin').value = fechaFin.toISOString().slice(0, 16);
            }

            // Actualizar campos según el tipo y luego establecer el valor
            await actualizarCamposDescuento();
            if (descuento.aplicaA) {
                document.getElementById('descuentoAplicaA').value = descuento.aplicaA;
            }

            document.getElementById('modalDescuento').classList.add('show');
        }

        async function toggleDescuentoActivo(id) {
            const descuento = descuentosData.find(d => d.id === id);
            if (!descuento) return;

            try {
                const response = await fetch(`/api/descuentos/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ ...descuento, activo: !descuento.activo })
                });

                if (response.ok) {
                    cargarDescuentos();
                } else {
                    alert('Error al cambiar el estado del descuento');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cambiar el estado del descuento');
            }
        }

        async function eliminarDescuento(id) {
            if (!confirm('¿Estás seguro de que quieres eliminar este descuento?')) return;

            try {
                const response = await fetch(`/api/descuentos/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    cargarDescuentos();
                    alert('Descuento eliminado correctamente');
                } else {
                    alert('Error al eliminar el descuento');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al eliminar el descuento');
            }
        }

        // ==================== FUNCIONES DE CLIENTES ====================

        let clientesData = [];

        async function cargarClientes() {
            console.log('🔄 Iniciando carga de clientes...');
            try {
                const response = await fetch('/api/admin/clientes', {
                    credentials: 'include'
                });

                console.log('📡 Respuesta recibida:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('❌ Error en respuesta:', errorText);
                    throw new Error('Error al cargar clientes: ' + response.status);
                }

                clientesData = await response.json();
                console.log('✅ Clientes cargados:', clientesData.length, clientesData);
                mostrarClientes(clientesData);
                actualizarEstadisticasClientes(clientesData);
            } catch (error) {
                console.error('❌ Error completo:', error);
                document.getElementById('clientes-tabla').innerHTML =
                    '<tr><td colspan="7" class="error">Error al cargar clientes: ' + error.message + '</td></tr>';
            }
        }

        function actualizarEstadisticasClientes(clientes) {
            const totalClientes = clientes.length;
            const clientesConPedidos = clientes.filter(c => c.estadisticas.totalPedidos > 0).length;
            const ingresosTotales = clientes.reduce((sum, c) => sum + c.estadisticas.totalGastado, 0);

            document.getElementById('total-clientes').textContent = totalClientes;
            document.getElementById('clientes-con-pedidos').textContent = clientesConPedidos;
            document.getElementById('ingresos-clientes').textContent = '€' + ingresosTotales.toFixed(2);
        }

        function mostrarClientes(clientes) {
            console.log('🖼️ Mostrando clientes en tabla:', clientes.length);
            const tbody = document.getElementById('clientes-tabla');

            if (!tbody) {
                console.error('❌ No se encontró el elemento clientes-tabla');
                return;
            }

            if (clientes.length === 0) {
                console.log('⚠️ No hay clientes para mostrar');
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">No hay clientes registrados</td></tr>';
                return;
            }

            tbody.innerHTML = clientes.map(cliente => {
                const fechaRegistro = new Date(cliente.fechaRegistro);
                const fechaFormateada = fechaRegistro.toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });

                let ultimoPedido = 'Sin pedidos';
                if (cliente.estadisticas.ultimoPedido) {
                    const fechaUltimo = new Date(cliente.estadisticas.ultimoPedido.fecha);
                    ultimoPedido = fechaUltimo.toLocaleDateString('es-ES', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                }

                // Determinar color según actividad
                let badgeColor = '#999';
                if (cliente.estadisticas.totalPedidos >= 5) {
                    badgeColor = '#4CAF50'; // Verde - Cliente VIP
                } else if (cliente.estadisticas.totalPedidos >= 2) {
                    badgeColor = '#2196F3'; // Azul - Cliente regular
                } else if (cliente.estadisticas.totalPedidos === 1) {
                    badgeColor = '#FF9800'; // Naranja - Cliente nuevo
                }

                return `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 40px; height: 40px; border-radius: 50%; background: ${badgeColor}; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600;">
                                    ${cliente.nombre.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <div style="font-weight: 600;">${cliente.nombre}</div>
                                    ${cliente.estadisticas.totalPedidos >= 5 ? '<span style="font-size: 0.75em; color: #4CAF50;">⭐ VIP</span>' : ''}
                                </div>
                            </div>
                        </td>
                        <td>${cliente.email}</td>
                        <td>${cliente.telefono || '-'}</td>
                        <td>${fechaFormateada}</td>
                        <td>
                            <span style="background: ${badgeColor}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">
                                ${cliente.estadisticas.totalPedidos}
                            </span>
                        </td>
                        <td style="font-weight: 600; color: #4CAF50;">€${cliente.estadisticas.totalGastado.toFixed(2)}</td>
                        <td style="font-size: 0.9em; color: #666;">${ultimoPedido}</td>
                    </tr>
                `;
            }).join('');
        }

        function filtrarClientes() {
            const busqueda = document.getElementById('buscar-cliente').value.toLowerCase();
            const clientesFiltrados = clientesData.filter(cliente => {
                return cliente.nombre.toLowerCase().includes(busqueda) ||
                       cliente.email.toLowerCase().includes(busqueda);
            });
            mostrarClientes(clientesFiltrados);
        }

        // ==================== GESTIÓN DE TICKETS ====================

        let ticketsData = [];
        let cargandoTickets = false;

        async function cargarTickets() {
            if (cargandoTickets) {
                console.log('⏸️ Ya se están cargando tickets, saltando...');
                return;
            }

            cargandoTickets = true;
            console.log('🎫 Cargando tickets...');
            try {
                const response = await fetch('/api/tickets', { credentials: 'include' });
                console.log('📡 Respuesta de tickets:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const tickets = await response.json();
                console.log('✅ Tickets recibidos:', tickets.length, tickets);

                ticketsData = tickets;
                mostrarTickets(tickets);
                actualizarEstadisticasTickets(tickets);
            } catch (error) {
                console.error('❌ Error cargando tickets:', error);
                const tbody = document.getElementById('tickets-tabla');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #f44336;">Error al cargar tickets: ' + error.message + '</td></tr>';
                }
            } finally {
                cargandoTickets = false;
            }
        }

        function actualizarEstadisticasTickets(tickets) {
            const totalTickets = tickets.length;
            const ticketsNuevos = tickets.filter(t => t.estado === 'Nuevo').length;
            const ticketsEnProceso = tickets.filter(t => t.estado === 'En Proceso').length;
            const ticketsResueltos = tickets.filter(t => t.estado === 'Resuelto').length;

            document.getElementById('total-tickets').textContent = totalTickets;
            document.getElementById('tickets-nuevos').textContent = ticketsNuevos;
            document.getElementById('tickets-en-proceso').textContent = ticketsEnProceso;
            document.getElementById('tickets-resueltos').textContent = ticketsResueltos;
        }

        function mostrarTickets(tickets) {
            console.log('📋 Mostrando tickets en tabla:', tickets.length);
            const tbody = document.getElementById('tickets-tabla');

            if (!tbody) {
                console.error('❌ No se encontró el elemento tickets-tabla');
                return;
            }

            if (tickets.length === 0) {
                console.log('ℹ️ No hay tickets para mostrar');
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #999;">No hay tickets de soporte</td></tr>';
                return;
            }

            console.log('🔨 Generando HTML para', tickets.length, 'tickets');
            tbody.innerHTML = tickets.map(ticket => {
                const fecha = new Date(ticket.fechaCreacion);
                const fechaFormateada = fecha.toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                let estadoColor = '#999';
                switch(ticket.estado) {
                    case 'Nuevo': estadoColor = '#2196F3'; break;
                    case 'En Proceso': estadoColor = '#FF9800'; break;
                    case 'Resuelto': estadoColor = '#4CAF50'; break;
                    case 'Cerrado': estadoColor = '#757575'; break;
                }

                let prioridadColor = '#999';
                switch(ticket.prioridad) {
                    case 'Baja': prioridadColor = '#4CAF50'; break;
                    case 'Media': prioridadColor = '#FF9800'; break;
                    case 'Alta': prioridadColor = '#FF5722'; break;
                    case 'Urgente': prioridadColor = '#F44336'; break;
                }

                return `
                    <tr>
                        <td style="font-weight: 600;">#${ticket.id}</td>
                        <td>${ticket.nombre}</td>
                        <td style="color: #666; font-size: 0.9em;">${ticket.email}</td>
                        <td>${ticket.asunto}</td>
                        <td>
                            <span style="background: ${estadoColor}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">
                                ${ticket.estado}
                            </span>
                        </td>
                        <td>
                            <span style="background: ${prioridadColor}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">
                                ${ticket.prioridad}
                            </span>
                        </td>
                        <td style="font-size: 0.9em; color: #666;">${fechaFormateada}</td>
                        <td>
                            <button onclick="abrirModalTicket(${ticket.id})" class="btn-primary" style="padding: 6px 12px; font-size: 0.85em;">
                                👁️ Ver
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            console.log('✅ Tabla de tickets actualizada correctamente');
        }

        function filtrarTickets() {
            const estadoFiltro = document.getElementById('filtro-estado-ticket').value;
            let ticketsFiltrados = ticketsData;

            if (estadoFiltro) {
                ticketsFiltrados = ticketsData.filter(ticket => ticket.estado === estadoFiltro);
            }

            mostrarTickets(ticketsFiltrados);
        }

        async function abrirModalTicket(ticketId) {
            try {
                const response = await fetch(`/api/tickets/${ticketId}`, { credentials: 'include' });
                const ticket = await response.json();

                document.getElementById('modalTicketTitulo').textContent = `Ticket #${ticket.id} - ${ticket.asunto}`;

                const contenido = document.getElementById('ticketDetalleContenido');
                contenido.innerHTML = `
                    <div style="background: #f5f5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div>
                                <strong>Cliente:</strong><br>
                                ${ticket.nombre}<br>
                                <span style="color: #666; font-size: 0.9em;">${ticket.email}</span>
                            </div>
                            <div>
                                <strong>Estado:</strong><br>
                                <select id="ticketEstado" class="form-control" style="margin-top: 5px;">
                                    <option value="Nuevo" ${ticket.estado === 'Nuevo' ? 'selected' : ''}>Nuevo</option>
                                    <option value="En Proceso" ${ticket.estado === 'En Proceso' ? 'selected' : ''}>En Proceso</option>
                                    <option value="Resuelto" ${ticket.estado === 'Resuelto' ? 'selected' : ''}>Resuelto</option>
                                    <option value="Cerrado" ${ticket.estado === 'Cerrado' ? 'selected' : ''}>Cerrado</option>
                                </select>
                            </div>
                            <div>
                                <strong>Prioridad:</strong><br>
                                <select id="ticketPrioridad" class="form-control" style="margin-top: 5px;">
                                    <option value="Baja" ${ticket.prioridad === 'Baja' ? 'selected' : ''}>Baja</option>
                                    <option value="Media" ${ticket.prioridad === 'Media' ? 'selected' : ''}>Media</option>
                                    <option value="Alta" ${ticket.prioridad === 'Alta' ? 'selected' : ''}>Alta</option>
                                    <option value="Urgente" ${ticket.prioridad === 'Urgente' ? 'selected' : ''}>Urgente</option>
                                </select>
                            </div>
                            <div>
                                <strong>Fecha de creación:</strong><br>
                                ${new Date(ticket.fechaCreacion).toLocaleString('es-ES')}
                            </div>
                        </div>
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button onclick="actualizarTicket(${ticket.id})" class="btn-primary">💾 Guardar Cambios</button>
                            <button onclick="eliminarTicket(${ticket.id})" class="btn-secondary" style="background: #f44336;">🗑️ Eliminar Ticket</button>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h3 style="margin-bottom: 15px;">💬 Conversación</h3>
                        <div style="display: flex; flex-direction: column; gap: 15px; max-height: 400px; overflow-y: auto; padding: 10px;">
                            ${ticket.mensajes.map(mensaje => {
                                const esAdmin = mensaje.tipo === 'admin';
                                const archivosHTML = mensaje.archivos && mensaje.archivos.length > 0
                                    ? `<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid ${esAdmin ? 'rgba(255,255,255,0.3)' : 'rgba(0,0,0,0.1)'};">
                                        <div style="font-size: 0.85em; margin-bottom: 5px; opacity: 0.8;">📎 Archivos adjuntos:</div>
                                        ${mensaje.archivos.map(archivo => `
                                            <div style="margin: 5px 0;">
                                                <a href="${archivo.ruta}" target="_blank" download style="color: ${esAdmin ? 'white' : '#667eea'}; text-decoration: underline; font-size: 0.85em;">
                                                    📄 ${archivo.nombre} (${(archivo.tamaño / 1024).toFixed(2)} KB)
                                                </a>
                                            </div>
                                        `).join('')}
                                       </div>`
                                    : '';
                                return `
                                    <div style="display: flex; ${esAdmin ? 'justify-content: flex-end' : 'justify-content: flex-start'};">
                                        <div style="max-width: 70%; background: ${esAdmin ? '#667eea' : '#f0f0f0'}; color: ${esAdmin ? 'white' : '#333'}; padding: 15px; border-radius: 15px; ${esAdmin ? 'border-bottom-right-radius: 5px;' : 'border-bottom-left-radius: 5px;'}">
                                            <div style="font-weight: 600; margin-bottom: 5px; font-size: 0.9em; opacity: 0.9;">
                                                ${mensaje.autor}
                                            </div>
                                            <div style="white-space: pre-wrap;">${mensaje.mensaje}</div>
                                            ${archivosHTML}
                                            <div style="font-size: 0.75em; margin-top: 8px; opacity: 0.7;">
                                                ${new Date(mensaje.fecha).toLocaleString('es-ES')}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <div style="background: #f9f9f9; padding: 20px; border-radius: 10px;">
                        <h3 style="margin-bottom: 15px;">✍️ Responder al Cliente</h3>
                        <textarea id="ticketRespuesta" class="form-control" rows="4" placeholder="Escribe tu respuesta aquí..."></textarea>
                        <button onclick="responderTicket(${ticket.id})" class="btn-primary" style="margin-top: 10px;">📧 Enviar Respuesta</button>
                    </div>
                `;

                document.getElementById('modalTicket').style.display = 'flex';
            } catch (error) {
                console.error('Error cargando ticket:', error);
                alert('Error al cargar el ticket');
            }
        }

        function cerrarModalTicket() {
            document.getElementById('modalTicket').style.display = 'none';
        }

        async function actualizarTicket(ticketId) {
            const nuevoEstado = document.getElementById('ticketEstado').value;
            const nuevaPrioridad = document.getElementById('ticketPrioridad').value;

            try {
                // Actualizar estado
                await fetch(`/api/tickets/${ticketId}/estado`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ estado: nuevoEstado })
                });

                // Actualizar prioridad
                await fetch(`/api/tickets/${ticketId}/prioridad`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ prioridad: nuevaPrioridad })
                });

                alert('Ticket actualizado correctamente');
                cargarTickets();
                cerrarModalTicket();
            } catch (error) {
                console.error('Error actualizando ticket:', error);
                alert('Error al actualizar el ticket');
            }
        }

        async function responderTicket(ticketId) {
            const mensaje = document.getElementById('ticketRespuesta').value.trim();

            if (!mensaje) {
                alert('Por favor, escribe un mensaje');
                return;
            }

            try {
                await fetch(`/api/tickets/${ticketId}/mensajes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ mensaje })
                });

                alert('Respuesta enviada correctamente');
                abrirModalTicket(ticketId); // Recargar el modal para ver la respuesta
            } catch (error) {
                console.error('Error enviando respuesta:', error);
                alert('Error al enviar la respuesta');
            }
        }

        async function eliminarTicket(ticketId) {
            if (!confirm('¿Estás seguro de que deseas eliminar este ticket?')) {
                return;
            }

            try {
                await fetch(`/api/tickets/${ticketId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                alert('Ticket eliminado correctamente');
                cargarTickets();
                cerrarModalTicket();
            } catch (error) {
                console.error('Error eliminando ticket:', error);
                alert('Error al eliminar el ticket');
            }
        }

        // ==================== FIN GESTIÓN DE TICKETS ====================

        // ==================== GESTIÓN DE MARKETING ====================

        let clientesSeleccionados = [];
        let productoActualRRSS = null;

        // Cambiar entre pestañas de marketing
        function showMarketingTab(tab) {
            // Ocultar todas las pestañas
            document.querySelectorAll('.marketing-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));

            // Mostrar la pestaña seleccionada
            document.getElementById(`marketing-${tab}`).classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');

            // Cargar datos según la pestaña
            if (tab === 'correo') {
                cargarClientesMarketing();
            } else if (tab === 'rrss') {
                cargarProductosRRSS();
            }
        }

        // Cargar clientes con sus gastos
        async function cargarClientesMarketing() {
            try {
                const response = await fetch('/api/pedidos', {
                    credentials: 'include'
                });
                const pedidos = await response.json();

                // Agrupar pedidos por cliente
                const clientesMap = {};

                pedidos.forEach(pedido => {
                    const email = pedido.email || 'sin-email@example.com';
                    const nombre = pedido.nombre || 'Cliente sin nombre';

                    if (!clientesMap[email]) {
                        clientesMap[email] = {
                            email: email,
                            nombre: nombre,
                            pedidos: 0,
                            totalGastado: 0,
                            ultimoPedido: pedido.fecha
                        };
                    }

                    clientesMap[email].pedidos++;
                    clientesMap[email].totalGastado += pedido.total || 0;

                    // Actualizar última fecha de pedido
                    if (new Date(pedido.fecha) > new Date(clientesMap[email].ultimoPedido)) {
                        clientesMap[email].ultimoPedido = pedido.fecha;
                    }
                });

                // Convertir a array y ordenar por total gastado
                const clientes = Object.values(clientesMap).sort((a, b) => b.totalGastado - a.totalGastado);

                const tbody = document.getElementById('tabla-clientes-marketing');
                if (clientes.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                                No hay clientes registrados
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = clientes.map(cliente => `
                    <tr>
                        <td><input type="checkbox" class="cliente-checkbox" value="${cliente.email}" onchange="toggleClienteSeleccion('${cliente.email}')"></td>
                        <td style="font-weight: 600;">${cliente.nombre}</td>
                        <td>${cliente.email}</td>
                        <td><span class="status-badge" style="background: #4caf50;">${cliente.pedidos}</span></td>
                        <td style="font-weight: 700; color: #667eea;">€${cliente.totalGastado.toFixed(2)}</td>
                        <td>${new Date(cliente.ultimoPedido).toLocaleDateString()}</td>
                        <td>
                            <button class="action-btn edit-btn" onclick="enviarEmailIndividual('${cliente.email}', '${cliente.nombre}')" title="Enviar Email">
                                ✉️
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error cargando clientes:', error);
                document.getElementById('tabla-clientes-marketing').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #f44336;">
                            Error al cargar clientes
                        </td>
                    </tr>
                `;
            }
        }

        // Seleccionar/deseleccionar cliente
        function toggleClienteSeleccion(email) {
            const index = clientesSeleccionados.indexOf(email);
            if (index > -1) {
                clientesSeleccionados.splice(index, 1);
            } else {
                clientesSeleccionados.push(email);
            }
        }

        // Seleccionar/deseleccionar todos los clientes
        function toggleSelectAllClientes() {
            const selectAll = document.getElementById('select-all-clientes').checked;
            const checkboxes = document.querySelectorAll('.cliente-checkbox');

            clientesSeleccionados = [];
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll;
                if (selectAll) {
                    clientesSeleccionados.push(checkbox.value);
                }
            });
        }

        // Abrir modal para enviar email masivo
        function abrirModalEmailMasivo() {
            if (clientesSeleccionados.length === 0) {
                alert('Por favor, selecciona al menos un cliente');
                return;
            }

            document.getElementById('destinatarios-list').innerHTML = clientesSeleccionados.map(email =>
                `<div style="background: white; padding: 5px 10px; margin: 5px; border-radius: 5px; display: inline-block;">
                    ${email}
                </div>`
            ).join('');

            document.getElementById('emailAsunto').value = '';
            document.getElementById('emailMensaje').value = '';
            document.getElementById('modalEmail').classList.add('show');
        }

        // Enviar email individual
        function enviarEmailIndividual(email, nombre) {
            clientesSeleccionados = [email];
            document.getElementById('destinatarios-list').innerHTML = `
                <div style="background: white; padding: 5px 10px; border-radius: 5px;">
                    ${nombre} (${email})
                </div>
            `;
            document.getElementById('emailAsunto').value = '';
            document.getElementById('emailMensaje').value = '';
            document.getElementById('modalEmail').classList.add('show');
        }

        // Cerrar modal de email
        function cerrarModalEmail() {
            document.getElementById('modalEmail').classList.remove('show');
        }

        // Enviar email
        async function enviarEmail(event) {
            event.preventDefault();

            const asunto = document.getElementById('emailAsunto').value;
            const mensaje = document.getElementById('emailMensaje').value;

            try {
                const response = await fetch('/api/marketing/enviar-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        destinatarios: clientesSeleccionados,
                        asunto: asunto,
                        mensaje: mensaje
                    })
                });

                if (response.ok) {
                    alert('Emails enviados correctamente');
                    cerrarModalEmail();
                    clientesSeleccionados = [];
                    document.getElementById('select-all-clientes').checked = false;
                    document.querySelectorAll('.cliente-checkbox').forEach(cb => cb.checked = false);
                } else {
                    throw new Error('Error al enviar emails');
                }
            } catch (error) {
                console.error('Error enviando emails:', error);
                alert('Error al enviar los emails. Por favor, intenta de nuevo.');
            }
        }

        // Cargar productos para RRSS
        async function cargarProductosRRSS() {
            try {
                const response = await fetch('/api/productos', {
                    credentials: 'include'
                });
                const productos = await response.json();

                const grid = document.getElementById('productos-rrss-grid');

                if (productos.length === 0) {
                    grid.innerHTML = '<p style="text-align: center; color: #999; grid-column: 1/-1;">No hay productos disponibles</p>';
                    return;
                }

                grid.innerHTML = productos.map(producto => {
                    const imagen = producto.variantes?.[0]?.imagenes?.[0] || producto.imagenes?.[0] || producto.imagen || 'https://via.placeholder.com/300';
                    return `
                        <div class="producto-rrss-card">
                            <img src="${imagen}" alt="${producto.nombre}">
                            <h3>${producto.nombre}</h3>
                            <p class="precio">€${producto.precio.toFixed(2)}</p>
                            <button class="btn-primary" style="width: 100%;" onclick='abrirModalRRSS(${JSON.stringify(producto)})'>
                                📱 Compartir
                            </button>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error cargando productos:', error);
                document.getElementById('productos-rrss-grid').innerHTML = '<p style="text-align: center; color: #f44336; grid-column: 1/-1;">Error al cargar productos</p>';
            }
        }

        // Abrir modal de RRSS
        function abrirModalRRSS(producto) {
            productoActualRRSS = producto;

            const imagen = producto.variantes?.[0]?.imagenes?.[0] || producto.imagenes?.[0] || producto.imagen || 'https://via.placeholder.com/300';

            document.getElementById('rrss-producto-preview').innerHTML = `
                <div style="display: flex; gap: 15px; background: #f5f5f5; padding: 15px; border-radius: 10px;">
                    <img src="${imagen}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px;">
                    <div>
                        <h3 style="margin: 0 0 10px 0;">${producto.nombre}</h3>
                        <p style="font-size: 1.2em; color: #667eea; font-weight: bold; margin: 0;">€${producto.precio.toFixed(2)}</p>
                    </div>
                </div>
            `;

            // Texto por defecto
            const textoDefault = `🎃 ¡Halloween en ShoeLandia! 10% de descuento en todos los productos 🎃\n\n✨ ${producto.nombre}\n💰 Precio: €${producto.precio.toFixed(2)}\n\n¡Aprovecha esta oferta exclusiva! 👟\n\n#ShoeLandia #Halloween #Zapatos #Ofertas #Moda`;

            document.getElementById('rrssTexto').value = textoDefault;
            document.getElementById('modalRRSS').classList.add('show');
        }

        // Cerrar modal de RRSS
        function cerrarModalRRSS() {
            document.getElementById('modalRRSS').classList.remove('show');
            productoActualRRSS = null;
        }

        // Publicar directamente en Instagram
        async function publicarEnInstagram() {
            const texto = document.getElementById('rrssTexto').value;
            const imagen = productoActualRRSS.variantes?.[0]?.imagenes?.[0] || productoActualRRSS.imagenes?.[0] || productoActualRRSS.imagen;

            const statusDiv = document.getElementById('instagram-status');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '⏳ Publicando en Instagram...';

            try {
                const response = await fetch('/api/instagram/publicar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        producto: productoActualRRSS,
                        texto: texto,
                        imagenUrl: imagen
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    statusDiv.innerHTML = '✅ ¡Publicado exitosamente en Instagram!';
                    setTimeout(() => {
                        cerrarModalRRSS();
                    }, 2000);
                } else {
                    throw new Error(data.error || 'Error al publicar');
                }
            } catch (error) {
                console.error('Error publicando en Instagram:', error);
                statusDiv.innerHTML = `❌ Error: ${error.message}<br><small>Verifica la configuración de Instagram en el archivo .env</small>`;
            }
        }

        // Compartir en redes sociales
        function compartirEnRRSS(redSocial) {
            const texto = document.getElementById('rrssTexto').value;
            const productoUrl = `https://shoelandia.es/producto/${productoActualRRSS.id}`;

            let url = '';

            switch(redSocial) {
                case 'facebook':
                    url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(productoUrl)}&quote=${encodeURIComponent(texto)}`;
                    window.open(url, '_blank', 'width=600,height=400');
                    break;

                case 'twitter':
                    url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(texto)}&url=${encodeURIComponent(productoUrl)}`;
                    window.open(url, '_blank', 'width=600,height=400');
                    break;
            }

            // Registrar la acción
            fetch('/api/marketing/registrar-compartir', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                    productoId: productoActualRRSS.id,
                    redSocial: redSocial,
                    texto: texto
                })
            }).catch(console.error);
        }

        // ==================== FIN GESTIÓN DE MARKETING ====================

        // Verificar sesión y cargar datos al inicio
        (async () => {
            const sesionValida = await verificarSesion();
            if (sesionValida) {
                cargarPedidos();
                cargarProductos();
                cargarUltimaActualizacion();
                cargarDescuentos();
                cargarClientes();
                cargarTickets();
                cargarUltimosPedidosDashboard();
                cargarUltimosProductosDashboard();
                // Auto-actualizar cada 30 segundos
                setInterval(() => {
                    cargarPedidos();
                    cargarTickets();
                    cargarUltimosPedidosDashboard();
                }, 30000);
            }
        })();
    </script>
</body>
</html>
